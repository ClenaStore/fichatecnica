<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Painel de An√°lise ‚Ä¢ Receitas</title>
<style>
  :root{
    --bg:#0f0f10; --panel:#141414; --line:#2a2a2a; --text:#f0f0f0; --muted:#cfcfcf;
    --brand:#2563eb; --ghost:#374151; --accent:#b75507; --danger:#ef4444; --ok:#16a34a;
    --foto-size: 200px;
  }
  *{box-sizing:border-box}
  body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text);margin:0;padding:24px}

  header{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:20px;}
  h1{margin:0; font-size:1.6rem; font-weight:700}

  .btn{cursor:pointer;border:0;border-radius:12px;padding:10px 16px;font-size:.95rem;transition:.2s}
  .btn:hover{opacity:.92}
  .btn.primary{background:var(--brand); color:#fff;}
  .btn.secondary{background:#334155; color:#fff;}
  .btn.ghost{background:transparent; border:1px solid var(--ghost); color:var(--text);}
  .btn.back{background:var(--accent); color:#fff;}
  .btn.danger{background:var(--danger); color:#fff;}
  .btn.ok{background:var(--ok); color:#fff;}

  .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:18px;margin-bottom:18px;box-shadow:0 4px 20px rgba(0,0,0,.3)}
  .row{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
  label{font-size:.85rem;color:var(--muted)}
  input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #333;background:#0f0f10;color:#fff}
  textarea{min-height:72px}
  .right{text-align:right}
  .muted{opacity:.85}
  .small{font-size:.9rem}
  .pill{padding:4px 8px;border-radius:999px;border:1px solid var(--ghost);font-size:.8rem;background:#111}
  .tag{display:inline-block;padding:2px 8px;border-radius:999px;background:#0f172a;border:1px solid #334155;color:#cbd5e1;font-size:.75rem}
  .link{cursor:pointer;color:#93c5fd}
  .actions{ display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap }
  .actions .btn{ flex:0 0 auto }

  .tbl-wrap{overflow:auto;border:1px solid var(--line);border-radius:12px}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  #tblReceitas{ min-width: 980px; }
  th,td{border:1px solid var(--line);padding:8px;text-align:left;vertical-align:top}
  th{ background:#fff; color:#000; font-weight:600; border:1px solid var(--line); }
  .best{outline:2px solid #16a34a; background:rgba(22,163,74,.12)}
  .best::after{content:" üíö"}

  .comp-badge{display:inline-block;margin-left:6px;padding:2px 6px;border-radius:999px;border:1px solid #7c3aed;background:#1f1433;color:#e9d5ff;font-size:.72rem}

  /* ===== Modal ===== */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:50;padding:8px}
  .modal .box{width:100%;max-width:1100px;max-height:90vh;overflow:auto;background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:16px}
  .m-head{display:grid;grid-template-columns: 1fr auto;gap:16px;align-items:start;margin-bottom:8px;}
  .m-title{display:flex;flex-direction:column;gap:4px}
  .m-title .name{font-size:1.4rem;font-weight:700;margin:0;line-height:1.1}
  .m-title .sub{font-size:.95rem;color:var(--muted)}
  .m-right{display:grid;grid-template-rows:auto auto;gap:10px;align-items:start;justify-items:end}
  .m-actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .ctrl{height:40px; padding:10px 14px; border-radius:12px}
  .ctrl.w{width:220px}
  .foto{ width:var(--foto-size); height:var(--foto-size); object-fit:cover; border-radius:12px; border:1px solid var(--line); box-shadow:0 6px 20px rgba(0,0,0,.35); }
  #tblDet{ min-width: 900px; }

  .edit-grid{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
  .edit-grid .c3{grid-column:span 3}
  .edit-grid .c4{grid-column:span 4}
  .edit-grid .c6{grid-column:span 6}
  .edit-grid .c8{grid-column:span 8}
  .edit-grid .c12{grid-column:span 12}
  .help{font-size:.8rem;color:var(--muted)}

  .hist-modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:52;padding:8px}
  .hist-modal .box{width:100%;max-width:1100px;max-height:90vh;overflow:auto;background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:16px}
  .h-filtros{display:grid;grid-template-columns:repeat(12,1fr);gap:10px;margin-bottom:10px}
  .h-filtros > div{grid-column: span 3}
  .h-filtros .w2{grid-column: span 2}
  .h-filtros .w4{grid-column: span 4}
  .h-table{border:1px solid var(--line);border-radius:12px;overflow:auto}
  .h-table table{ min-width: 760px; }

  /* ===== Caret para compostos ===== */
  .caret-btn{
    background:transparent; border:0; cursor:pointer; font-size:1rem;
    line-height:1; padding:0 6px 0 0; color:var(--text);
    transform-origin:center; transition:transform .15s ease;
  }
  .caret-btn[aria-expanded="true"]{ transform:rotate(90deg); }
  .comp-row{ background:#0f0f10; }
  .comp-row td{ padding:10px 12px; border-top:0; }

  @media (hover:none){ .btn{ min-height:44px } }
  @media (max-width: 1024px){ body{ padding:18px } }
  @media (max-width: 768px){
    :root{ --foto-size: 140px; }
    body{padding:12px}
    header{flex-direction:column;align-items:flex-start;gap:10px}
    .row{grid-template-columns:1fr;gap:10px}
    .actions{ justify-content:stretch }
    .actions .btn{ flex:1 1 140px }
    .m-head{grid-template-columns: 1fr}
    .m-right{justify-items:start}
    .ctrl.w{width:100%}
    .h-filtros{grid-template-columns:1fr}
    .h-filtros > div{grid-column: span 1}
    .card{ padding:14px }
    th,td{ white-space:nowrap }
    .edit-grid{grid-template-columns:1fr}
    .edit-grid > div{grid-column:span 1}
  }
</style>
</head>
<body>
  <header>
    <button class="btn back" onclick="window.location.href='index.html'">‚¨Ö Voltar</button>
    <h1>Painel de An√°lise de Receitas</h1>
    <span></span>
  </header>

  <div class="card">
    <div class="row">
      <div style="grid-column: span 3">
        <label>Empresa</label>
        <select id="fEmpresa"><option value="">(Todas)</option></select>
      </div>
      <div style="grid-column: span 5">
        <label>Buscar</label>
        <input id="fBusca" placeholder="Item, classifica√ß√£o, c√≥digo...">
      </div>
      <div style="grid-column: span 4;align-self:end" class="actions">
        <button class="btn ghost" id="btnHistorico">Hist√≥rico</button>
        <button class="btn primary" onclick="window.location.href='relatorios.html'">AN√ÅLISES DE CUSTO</button>
        <button class="btn secondary" id="btnAtualizar">Atualizar</button>
      </div>
    </div>
    <div id="metaInfo" class="small muted" style="margin-top:8px"></div>
  </div>

  <div class="card">
    <div class="tbl-wrap">
      <table id="tblReceitas">
        <thead>
          <tr>
            <th>Empresa</th><th>C√≥digo</th><th>N¬∫</th><th>Item</th><th>Classifica√ß√£o</th>
            <th>Rendimento</th><th>U.M.</th><th class="right">Custo da Receita</th>
            <th class="right">Custo por kg/L</th><th>Data</th><th>Usu√°rio</th>
          </tr>
        </thead>
        <tbody id="tbodyReceitas"></tbody>
      </table>
    </div>
  </div>

  <!-- Modal Detalhe + Edi√ß√£o -->
  <div class="modal" id="modal">
    <div class="box">
      <div class="m-head">
        <div class="m-title">
          <div id="mTitulo" class="name"></div>
          <div id="mSub" class="sub"></div>
        </div>
        <div class="m-right">
          <div class="m-actions">
            <label class="small" for="mCompare" style="margin-right:6px">Empresas</label>
            <select id="mCompare" class="ctrl w"></select>
            <button class="btn danger ctrl" id="mExcluir">Excluir Receita</button>
            <button class="btn primary ctrl" id="mEditar">Editar Receita</button>
            <button class="btn ghost ctrl" id="mFechar">Fechar</button>
          </div>
          <img id="mFoto" class="foto" alt="foto" style="display:none"/>
        </div>
      </div>

      <div id="mResumo" class="pill" style="margin-bottom:12px"></div>

      <!-- VISUALIZA√á√ÉO -->
      <div id="viewBlk">
        <div class="tbl-wrap">
          <table id="tblDet">
            <thead id="theadDet"></thead>
            <tbody id="tbodyDet"></tbody>
          </table>
        </div>
        <div id="mTotals" class="row" style="margin-top:12px"></div>
        <div id="mExplain" class="small muted" style="margin-top:6px"></div>
      </div>

      <!-- EDI√á√ÉO -->
      <div id="editBlk" style="display:none;margin-top:10px">
        <div class="pill" style="margin-bottom:10px">Modo de edi√ß√£o</div>
        <div class="edit-grid">
          <div class="c8">
            <label>Item (nome da receita)</label>
            <input id="eItem" />
          </div>
          <div class="c4">
            <label>Classifica√ß√£o</label>
            <input id="eClass" />
          </div>
          <div class="c3">
            <label>C√≥digo (sistema)</label>
            <input id="eCodigo" />
          </div>
          <div class="c3">
            <label>N√∫mero</label>
            <input id="eNumero" />
          </div>
          <div class="c3">
            <label>Rendimento</label>
            <input id="eRend" type="number" step="0.0001" />
          </div>
          <div class="c3">
            <label>U.M. do Rendimento</label>
            <select id="eRendUM">
              <option value="un">UN</option>
              <option value="kg">KG</option>
              <option value="ml">ML</option>
              <option value="l">L</option>
            </select>
          </div>
          <div class="c6">
            <label>Foto (URL ou ID do Drive)</label>
            <input id="eFoto" placeholder="https://drive.google.com/..." />
            <div class="help">Aceita URL/ID do Google Drive. A imagem aparece ao lado.</div>
          </div>
          <div class="c6">
            <label>Usu√°rio (respons√°vel)</label>
            <input id="eUsuario" />
          </div>

          <div class="c12">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:6px">
              <div style="font-weight:700">Ingredientes da Receita</div>
              <div style="display:flex;gap:6px">
                <button class="btn ghost" id="eAddIng">+ Adicionar ingrediente</button>
                <button class="btn ghost" id="eRecalc">Recalcular custos</button>
              </div>
            </div>
            <div class="tbl-wrap">
              <table id="tblEdit">
                <thead>
                  <tr>
                    <th style="min-width:240px">Item / Nome</th>
                    <th style="min-width:120px">C√≥digo</th>
                    <th class="right" style="min-width:110px">Qtd</th>
                    <th style="min-width:90px">U.M.</th>
                    <th style="min-width:140px">A√ß√µes</th>
                  </tr>
                </thead>
                <tbody id="eTbody"></tbody>
              </table>
            </div>
          </div>

          <div class="c12" style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
            <button class="btn ghost" id="eCancelar">Cancelar</button>
            <button class="btn ok" id="eSalvar">üíæ Salvar altera√ß√µes</button>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Modal Hist√≥rico -->
  <div class="hist-modal" id="histModal">
    <div class="box">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div style="font-weight:700;font-size:1.1rem">Hist√≥rico</div>
        <div><button class="btn ghost" id="hFechar">Fechar</button></div>
      </div>

      <div class="h-filtros">
        <div class="w2">
          <label>De</label>
          <input type="date" id="hDe">
        </div>
        <div class="w2">
          <label>At√©</label>
          <input type="date" id="hAte">
        </div>
        <div class="w4">
          <label>Empresa</label>
          <select id="hEmpresa"><option value="">(Todas)</option></select>
        </div>
        <div class="w4">
          <label>Item/Receita (busca)</label>
          <input id="hBusca" placeholder="Item, n¬∫, c√≥digo, usu√°rio...">
        </div>
      </div>

      <div class="small muted" id="hInfo" style="margin-bottom:6px"></div>

      <div class="h-table">
        <table style="width:100%;border-collapse:collapse">
          <thead>
            <tr>
              <th>Data</th><th>Usu√°rio</th><th>Entidade</th><th>A√ß√£o</th><th>Chave</th><th>Detalhes</th>
            </tr>
          </thead>
          <tbody id="hTbody"></tbody>
        </table>
      </div>

      <div id="hFallback" style="display:none;margin-top:10px">
        <button class="btn primary" id="hAbrirPlanilha">Abrir hist√≥rico no Google Sheets</button>
      </div>
    </div>
  </div>

  <!-- DATALIST com ingredientes cadastrados -->
  <datalist id="dlIng"></datalist>

<script>
/* ===== CONFIG ===== */
const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbwk2flkZoA4l5r1Ht0CXzvMU8Xxnzt49O9V-B57pxOHK9I6SqoCwJ2GalNcIoT9fqdv/exec'; /* ‚¨ÖÔ∏è sua implanta√ß√£o */

/* ===== ESTADO ===== */
let PRODUTOS = [];
let ING_TODOS = [];
let EMPRESAS = [];
let EMPRESA_ATUAL = '';
let HIST = [];
let HIST_LINK = '';

/* ===== HELPERS ===== */
const tbodyR = document.getElementById('tbodyReceitas');
const fmtBRL = v => (isNaN(v)?0:v).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
const norm = s => String(s||'').trim().toLowerCase();
const FACTOR = { g:1, kg:1000, ml:1, l:1000, un:1 };
const TYPE   = u => (u==='g'||u==='kg')?'mass' : (u==='ml'||u==='l')?'vol' : 'count';
function convertQty(qty, from, to){
  from=(from||'').toLowerCase(); to=(to||'').toLowerCase();
  if(!FACTOR[from]||!FACTOR[to]) return qty;
  if(TYPE(from)!==TYPE(to)) return NaN;
  return qty*(FACTOR[from]/FACTOR[to]);
}
function qtyUmFrom(r){
  const qtd = Number(r.qtd ?? r.quantidade ?? r.qtdReceita ?? 0);
  const um  = String(r.um ?? r.unidade ?? r.unidadeReceita ?? '').toLowerCase();
  return {qtd, um};
}
function driveImgSrc(uOrId, size=800){
  if(!uOrId) return '';
  const s = String(uOrId);
  let id = '';
  const m1 = s.match(/\/d\/([^/]+)/);
  const m2 = s.match(/[?&]id=([^&]+)/);
  if (m1 && m1[1]) id = m1[1];
  else if (m2 && m2[1]) id = m2[1];
  else if (/^[a-zA-Z0-9_-]{20,}$/.test(s)) id = s;
  if(!id) return s;
  return `https://drive.google.com/thumbnail?id=${id}&sz=w${size}`;
}
function parseBRDateTime(ts){
  const m = String(ts||'').match(/(\d{2})\/(\d{2})\/(\d{4})\s*-\s*(\d{2}):(\d{2})/);
  if(!m) return null;
  return new Date(Number(m[3]), Number(m[2])-1, Number(m[1]), Number(m[4]), Number(m[5]));
}

/* ==== helpers hist√≥rico ==== */
function hEsc(s){ return String(s).replace(/[&<>]/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[ch])); }
function hTryParseJSON(s){ if(!s) return null; try{ return JSON.parse(String(s)); }catch(_){ return null; } }
function hPretty(v){ try{ return JSON.stringify(v, null, 2); }catch(_){ return String(v); } }
function hRenderVal(v){
  if(v===undefined) return '<span class="small muted">‚Äî</span>';
  if(v===null)      return '<span class="small muted">null</span>';
  if(typeof v==='object') return `<pre style="white-space:pre-wrap;font-size:.8rem;margin:0">${hEsc(hPretty(v))}</pre>`;
  const t = String(v);
  return t.length>120 ? `<pre style="white-space:pre-wrap;font-size:.8rem;margin:0">${hEsc(t)}</pre>` : `<code>${hEsc(t)}</code>`;
}
function hKeysUnion(a,b){ return Array.from(new Set([...Object.keys(a||{}), ...Object.keys(b||{})])).sort(); }
function hDeepEq(a,b){ return JSON.stringify(a)===JSON.stringify(b); }
function hResumoAlteracoes(diffObj, antesObj, depoisObj){
  let map = {};
  if(diffObj && typeof diffObj==='object' && !Array.isArray(diffObj)){
    map = diffObj;
  }else if(antesObj || depoisObj){
    hKeysUnion(antesObj||{}, depoisObj||{}).forEach(k=>{
      const av = antesObj?antesObj[k]:undefined;
      const dv = depoisObj?depoisObj[k]:undefined;
      if(!hDeepEq(av,dv)) map[k] = {before: av, after: dv};
    });
  }
  const ks = Object.keys(map);
  const rows = ks.length
    ? ks.map(k=>`
        <tr>
          <td style="white-space:nowrap">${hEsc(k)}</td>
          <td style="vertical-align:top;background:rgba(239,68,68,.08)">${hRenderVal(map[k].before)}</td>
          <td style="vertical-align:top;background:rgba(34,197,94,.08)">${hRenderVal(map[k].after)}</td>
        </tr>`).join('')
    : `<tr><td colspan="3" class="small muted">Sem altera√ß√µes detectadas</td></tr>`;
  return `
    <div class="small muted">Resumo de altera√ß√µes</div>
    <div class="tbl-wrap" style="margin:6px 0">
      <table style="width:100%;border-collapse:collapse">
        <thead><tr><th>Campo</th><th>Antes</th><th>Depois</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
    </div>`;
}

/* ===== GAS ===== */
async function apiGet(path){
  const r = await fetch(WEBAPP_URL+path, {cache:'no-store'});
  return r.json();
}
async function apiPost(path, data){
  const r = await fetch(WEBAPP_URL+path, {
    method:'POST',
    headers:{'Content-Type':'text/plain;charset=utf-8'},
    body: JSON.stringify(data||{})
  });
  let j=null; try{ j=await r.json(); }catch(_){ j=null; }
  return j || {ok:false,error:'Resposta inv√°lida'};
}

/* Carrega empresas e ingredientes */
async function carregarEmpresas(){
  try{
    const [p,i] = await Promise.all([
      apiGet('?action=produtos&ts='+Date.now()),
      apiGet('?action=ingredientes&ts='+Date.now())
    ]);
    const set = new Set();
    if(p.ok) (p.data||[]).forEach(r=> r.empresa && set.add(r.empresa));
    if(i.ok) (i.data||[]).forEach(r=> r.empresa && set.add(r.empresa));
    EMPRESAS = [...set];
    ING_TODOS = i.ok ? (i.data||[]) : [];
  }catch(_){
    EMPRESAS = [];
    ING_TODOS = [];
  }
}
async function carregarDados(){
  const p = await apiGet('?action=produtos&ts='+Date.now());
  PRODUTOS = p.ok ? (p.data||[]) : [];
}

/* ===== RENDER LISTA ===== */
function renderEmpresasSelect(){
  const sel = document.getElementById('fEmpresa');
  sel.innerHTML = '<option value="">(Todas)</option>' + EMPRESAS.map(e=>`<option value="${e}">${e}</option>`).join('');
  if(EMPRESA_ATUAL){ sel.value = EMPRESA_ATUAL; }
}
function renderTabela(){
  const busca = norm(document.getElementById('fBusca').value);
  const emp = document.getElementById('fEmpresa').value;
  EMPRESA_ATUAL = emp;

  const arr = (PRODUTOS||[]).filter(r=>{
    const empOk = !emp || norm(r.empresa)===norm(emp);
    const bOk = !busca || [r.item,r.classificacao,r.codigoSistema,r.numero].some(v=> String(v||'').toLowerCase().includes(busca));
    return empOk && bOk;
  });

  tbodyR.innerHTML = '';
  arr.forEach((r,idx)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><span class="tag">${r.empresa||'-'}</span></td>
      <td>${r.codigoSistema||''}</td>
      <td>${r.numero||''}</td>
      <td><span class="link" data-idx="${idx}">${r.item||''}</span></td>
      <td>${r.classificacao||''}</td>
      <td>${r.rendimento||''}</td>
      <td>${(r.unidadeRend||'').toUpperCase()}</td>
      <td class="right">${fmtBRL(Number(r.custoReceita||0))}</td>
      <td class="right">${fmtBRL(Number(r.custoPorKgOuL||0))}</td>
      <td>${r.data||''}</td>
      <td>${r.usuario||''}</td>`;
    tbodyR.appendChild(tr);
  });

  tbodyR.querySelectorAll('.link').forEach(a=> a.addEventListener('click', (e)=>{
    const idx = Number(e.target.dataset.idx);
    const listaFiltrada = (PRODUTOS||[]).filter(r=>{
      const empOk = !EMPRESA_ATUAL || norm(r.empresa)===norm(EMPRESA_ATUAL);
      const b = norm(document.getElementById('fBusca').value);
      const bOk = !b || [r.item,r.classificacao,r.codigoSistema,r.numero].some(v=> String(v||'').toLowerCase().includes(b));
      return empOk && bOk;
    });
    const item = listaFiltrada[idx];
    if(item) abrirModal(item);
  }));

  document.getElementById('metaInfo').textContent = `${arr.length} receitas exibidas${emp?` ‚Ä¢ Empresa: ${emp}`:''}`;
}

/* ===== √çNDICE DE INGREDIENTES ===== */
function buildIngIndex(){
  const map = {};
  (ING_TODOS||[]).forEach(x=>{
    const emp = x.empresa||''; if(!map[emp]) map[emp]={};
    const keyCod  = x.codigo ? `#${String(x.codigo).trim()}` : null;
    const keyNome = `n:${norm(x.nome)}`;
    if(keyCod) map[emp][keyCod] = x;
    map[emp][keyNome] = x;
  });
  return map;
}
function acharIng(map, empresa, recItem){
  const keyCod = recItem.codigo ? `#${String(recItem.codigo).trim()}` : null;
  const keyNome = `n:${norm(recItem.item)}`;
  const m = map[empresa]||{};
  return (keyCod && m[keyCod]) || m[keyNome] || null;
}

/* ======= Compostos: c√°lculo local ======= */
function detalharComposto(ing, empresa, idx){
  if(!(ing && ing.tipo==='composto' && Array.isArray(ing.ingredientes))) return null;
  const umComp = String(ing.um||'').toLowerCase();
  const filhos = ing.ingredientes.map(spec=>{
    const keyCod = spec.codigo ? `#${String(spec.codigo).trim()}` : null;
    const keyNome = `n:${norm(spec.nome||spec.item||'')}`;
    const base = (idx[empresa]||{})[keyCod] || (idx[empresa]||{})[keyNome] || null;
    const umPreco   = String(base?.um||'').toLowerCase();
    const custoUnit = (typeof spec.custoUnit==='number') ? spec.custoUnit : Number(base?.custoUnit||0);
    const qtdComp   = Number(spec.qtd || spec.quantidade || 0);
    const umCompF   = String(spec.um||'').toLowerCase();
    const qtdConv   = (qtdComp>0 && umCompF && umPreco) ? convertQty(qtdComp, umCompF, umPreco) : null;
    const valor     = (qtdConv==null || isNaN(qtdConv)) ? null : Number((qtdConv * custoUnit).toFixed(6));
    return {
      nome: spec.nome || spec.item || base?.nome || '(ingrediente)',
      codigo: spec.codigo || base?.codigo || '',
      qtdComp, umComp: umCompF,
      umPreco, custoUnit,
      qtdConvertida: (qtdConv==null || isNaN(qtdConv)) ? null : qtdConv,
      valor
    };
  });
  const total = filhos.filter(f=> f.valor!=null).reduce((s,f)=> s+f.valor, 0);
  return { umComp, filhos, custoUnitComp: Number(total.toFixed(6)) };
}

/* ===== MODAL DETALHE + EDI√á√ÉO ===== */
const modal = document.getElementById('modal');
document.getElementById('mFechar').addEventListener('click', ()=> {
  modal.style.display='none';
  setEditMode(false);
});

let CURRENT_PROD = null;

async function compararViaAPI(rec){
  try{
    const {qtd, um} = qtyUmFrom(rec);
    const codigo = rec.codigo ? `codigo=${encodeURIComponent(rec.codigo)}` : '';
    const nome   = !rec.codigo ? `nome=${encodeURIComponent(rec.item||'')}` : '';
    const qs = (codigo || nome) + `&qtd=${encodeURIComponent(qtd||0)}&um=${encodeURIComponent(um)}`;
    const j = await apiGet(`?action=comparar_ingrediente&${qs}&ts=${Date.now()}`);
    if(j && j.ok) return j.data;
  }catch(_){}
  return null;
}
function compararLocal(rec){
  const {qtd, um} = qtyUmFrom(rec);
  const idxAll = buildIngIndex();
  const empresas = EMPRESAS.map(emp=>{
    const ing = acharIng(idxAll, emp, rec);
    if(!ing) return null;

    if(ing.tipo==='composto' && Array.isArray(ing.ingredientes)){
      const det = detalharComposto(ing, emp, idxAll);
      const umPreco = String(ing.um||'').toLowerCase();
      const conv = (qtd>0 && um) ? convertQty(qtd, um, umPreco) : null;
      const custo = Number(det?.custoUnitComp||0);
      const subtotal = (conv===null || isNaN(conv)) ? null : conv * custo;
      return {
        empresa: emp,
        codigo: ing.codigo||'',
        nome:   ing.nome||'',
        umPreco,
        custoUnit: custo,
        qtdConvertida: (conv===null||isNaN(conv))?null:conv,
        subtotal: (subtotal===null||isNaN(subtotal))?null:Number(subtotal.toFixed(6)),
        tipo: 'composto',
        comp: det?.filhos||[],
        compTotal: det?.custoUnitComp||0,
        compUm: det?.umComp||umPreco
      };
    }

    const umPreco = String(ing.um||'').toLowerCase();
    const conv = (qtd>0 && um) ? convertQty(qtd, um, umPreco) : null;
    const custo = Number(ing.custoUnit||0);
    const subtotal = (conv===null || isNaN(conv)) ? null : conv * custo;
    return {
      empresa: emp,
      codigo: ing.codigo||'',
      nome:   ing.nome||'',
      umPreco,
      custoUnit: custo,
      qtdConvertida: (conv===null||isNaN(conv))?null:conv,
      subtotal: (subtotal===null||isNaN(subtotal))?null:Number(subtotal.toFixed(6))
    };
  }).filter(Boolean);

  let idxBarato=-1, menor=Infinity;
  empresas.forEach((x,i)=>{ if(typeof x.custoUnit==='number' && x.custoUnit<menor){ menor=x.custoUnit; idxBarato=i; }});
  return {
    chave: rec.codigo ? {tipo:'codigo', valor:rec.codigo} : {tipo:'nome', valor:rec.item||''},
    qtd, umReceita: um, empresas, idxMaisBarata: idxBarato
  };
}

/* render auxiliar: tabela da composi√ß√£o por empresa */
function renderCompTable(x){
  if(!(x && x.tipo==='composto' && Array.isArray(x.comp))) return '';
  const rows = x.comp.map(f=>`
    <tr>
      <td>${f.nome||''}${f.codigo?` <span class="small muted">(cod: ${f.codigo})</span>`:''}</td>
      <td class="right">${Number(f.qtdComp||0)} ${(f.umComp||'').toUpperCase()}</td>
      <td class="right">${f.qtdConvertida!=null?f.qtdConvertida.toFixed(4):'‚Äî'} ${(f.umPreco||'').toUpperCase()}</td>
      <td class="right">${fmtBRL(f.custoUnit||0)}</td>
      <td class="right">${f.valor!=null?fmtBRL(f.valor):'‚Äî'}</td>
    </tr>
  `).join('');
  return `
    <div class="tbl-wrap" style="margin-top:6px">
      <table style="width:100%;border-collapse:collapse">
        <thead>
          <tr><th>Receita do ingrediente</th><th class="right">Qtd (comp.)</th><th class="right">Conv. ‚Üí pre√ßo</th><th class="right">Custo unit.</th><th class="right">Valor</th></tr>
        </thead>
        <tbody>${rows}</tbody>
        <tfoot>
          <tr><td colspan="4" class="right"><strong>Total (1 ${ (x.compUm||x.umPreco||'U.M.').toUpperCase() })</strong></td><td class="right"><strong>${fmtBRL(x.compTotal||0)}</strong></td></tr>
        </tfoot>
      </table>
    </div>
  `;
}

async function abrirModal(prod){
  CURRENT_PROD = structuredClone(prod || {});
  const baseEmp = prod.empresa || EMPRESA_ATUAL || '';

  const cmpSel = document.getElementById('mCompare');
  const opts = ['<option value="__ALL__">(Todas)</option>'].concat(EMPRESAS.map(e=>`<option value="${e}">${e}</option>`));
  cmpSel.innerHTML = opts.join('');
  cmpSel.value = '__ALL__';

  async function fetchComparativo(rec){
    const viaAPI = await compararViaAPI(rec);
    if(viaAPI) return viaAPI;
    return compararLocal(rec);
  }

  async function renderView(){
    const val = cmpSel.value;
    let empresasToShow = val==='__ALL__' ? [...EMPRESAS] : [val];
    if(!empresasToShow.includes(baseEmp)) empresasToShow.unshift(baseEmp);

    document.getElementById('mTitulo').textContent = `${prod.item||''}`;
    document.getElementById('mSub').textContent = `${prod.classificacao||''} ‚Ä¢ Empresa base: ${baseEmp} ‚Ä¢ N¬∫ ${prod.numero||''}`;

    const fotoEl = document.getElementById('mFoto');
    fotoEl.referrerPolicy = 'no-referrer';
    let fotoSrc = driveImgSrc(prod.fotoUrl || prod.fotoId, 800);
    if(!prod.fotoUrl && !prod.fotoId){
      const cand = (PRODUTOS||[]).find(p =>
        (p.codigoSistema && p.codigoSistema===prod.codigoSistema && p.fotoUrl) ||
        (p.item && norm(p.item)===norm(prod.item) && p.fotoUrl)
      );
      if(cand && cand.fotoUrl) fotoSrc = driveImgSrc(cand.fotoUrl, 800);
    }
    if(fotoSrc){ fotoEl.onerror=()=>{fotoEl.style.display='none'}; fotoEl.src=fotoSrc; fotoEl.style.display='block'; }
    else { fotoEl.style.display='none'; }

    const receita = Array.isArray(prod.receita) ? prod.receita : [];
    const thead = document.getElementById('theadDet');
    const tbody = document.getElementById('tbodyDet');
    thead.innerHTML = '';
    tbody.innerHTML = '';

    const thCols = ['Ingrediente','Qtd (receita)','U.M.'].concat(empresasToShow.map(e=>`Pre√ßo ‚Ä¢ ${e}`));
    const trH = document.createElement('tr');
    thCols.forEach(h=>{ const th=document.createElement('th'); th.textContent=h; if(h.startsWith('Pre√ßo')) th.className='right'; trH.appendChild(th); });
    thead.appendChild(trH);

    const totais = {}; empresasToShow.forEach(e=> totais[e]=0);

    const comps = await Promise.all(receita.map(r=>fetchComparativo(r)));

    /* ====== LISTA DE INGREDIENTES (COM CARET) ====== */
    receita.forEach((r, idxI)=>{
      const comp = comps[idxI];
      const {qtd, um} = qtyUmFrom(r);
      const porEmpresa = (comp?.empresas||[]).filter(x=> empresasToShow.includes(x.empresa));
      const validos = porEmpresa.filter(x=> x.subtotal!=null);
      const minVal = validos.length ? Math.min(...validos.map(x=>x.subtotal)) : null;

      const anyComp = porEmpresa.some(x=> x.tipo==='composto');

      // === linha principal do ingrediente ===
      const tr = document.createElement('tr');

      // bot√£o caret (aparece s√≥ se for composto)
      const caretHTML = anyComp
        ? `<button class="caret-btn" aria-expanded="false" title="Ver composi√ß√£o">‚ñ∂</button>`
        : '';

      const compMark = anyComp ? ' <span class="comp-badge">composto</span>' : '';
      tr.innerHTML = `
        <td>${caretHTML}${r.item||''}${r.codigo?` <span class="small muted">(cod: ${r.codigo})</span>`:''}${!comp?' <span class="small muted">‚Ä¢ sem cadastro</span>':''}${compMark}</td>
        <td class="right">${Number(qtd||0)}</td>
        <td>${(um||'').toUpperCase()}</td>
      `;

      // c√©lulas por empresa (pre√ßo / subtotal)
      empresasToShow.forEach(emp=>{
        const x = porEmpresa.find(e=> e.empresa===emp);
        const td = document.createElement('td'); td.className='right';
        if(!x){
          td.textContent='‚Äî';
          td.title = comp ? 'Sem cadastro desta empresa para este ingrediente' : 'Ingrediente n√£o encontrado';
        }else{
          if(x.subtotal!=null) totais[emp]+=x.subtotal;
          td.title = (x.qtdConvertida==null)
            ? `Sem convers√£o (unidades incompat√≠veis)`
            : `Convers√£o: ${qtd} ${(um||'').toLowerCase()} ‚Üí ${x.qtdConvertida.toFixed(4)} ${x.umPreco} ‚Ä¢ subtotal = ${x.qtdConvertida.toFixed(4)} √ó ${fmtBRL(x.custoUnit)}`;
          td.textContent = (x.subtotal==null)
            ? `${fmtBRL(x.custoUnit)} ‚Ä¢ ‚Äî`
            : `${fmtBRL(x.custoUnit)} ‚Ä¢ ${fmtBRL(x.subtotal)}`;
          if(minVal!=null && x.subtotal===minVal) td.classList.add('best');
        }
        tr.appendChild(td);
      });

      tbody.appendChild(tr);

      // === linha expand√≠vel com a composi√ß√£o ===
      let trComp = null;
      if(anyComp){
        trComp = document.createElement('tr');
        trComp.className = 'comp-row';
        const td = document.createElement('td');
        td.colSpan = 3 + empresasToShow.length;

        // monta uma se√ß√£o de composi√ß√£o por empresa que tenha tipo 'composto'
        const blocos = porEmpresa
          .filter(x=> x.tipo==='composto')
          .map(x => `
            <div class="small muted" style="margin:2px 0 6px">Composi√ß√£o ‚Ä¢ ${x.empresa}</div>
            ${renderCompTable(x)}
          `).join('');

        td.innerHTML = blocos || `<div class="small muted">Sem detalhes de composi√ß√£o.</div>`;
        trComp.style.display = 'none'; // come√ßa fechado
        trComp.appendChild(td);
        tbody.appendChild(trComp);

        // handler do caret
        const caretBtn = tr.querySelector('.caret-btn');
        caretBtn.addEventListener('click', () => {
          const open = caretBtn.getAttribute('aria-expanded') === 'true';
          caretBtn.setAttribute('aria-expanded', String(!open));
          trComp.style.display = open ? 'none' : 'table-row';
        });
      }
    });

    const totalsWrap = document.getElementById('mTotals');
    totalsWrap.innerHTML = '';
    empresasToShow.forEach(emp=>{
      const div = document.createElement('div');
      div.style.gridColumn = 'span 6';
      div.innerHTML = `<span class="pill">Total na empresa (${emp}): <strong>${fmtBRL(totais[emp]||0)}</strong></span>`;
      totalsWrap.appendChild(div);
    });

    document.getElementById('mResumo').textContent =
      `Rendimento: ${prod.rendimento||''} ${(prod.unidadeRend||'').toUpperCase()} ‚Ä¢ Itens: ${Array.isArray(prod.receita)?prod.receita.length:0}`;

    document.getElementById('mExplain').textContent =
      'Os pre√ßos v√™m do cadastro de ingredientes. A quantidade da receita √© convertida para a U.M. do pre√ßo (kg‚Üîg, L‚Üîml, un 1:1).';
  }

  await renderView();
  document.getElementById('mCompare').onchange = renderView;

  fillEditForm(CURRENT_PROD);
  modal.style.display='flex';
  setEditMode(false);
}

/* ====== EDIT MODE + AUTOCOMPLETE ====== */
const viewBlk = document.getElementById('viewBlk');
const editBlk = document.getElementById('editBlk');
document.getElementById('mEditar').addEventListener('click', ()=> {
  if(!CURRENT_PROD) return;
  setEditMode(true);
  rebuildIngDatalist(CURRENT_PROD.empresa || EMPRESA_ATUAL || '');
});
document.getElementById('eCancelar').addEventListener('click', ()=>{
  setEditMode(false);
  fillEditForm(CURRENT_PROD);
});

function setEditMode(on){
  viewBlk.style.display = on ? 'none' : 'block';
  editBlk.style.display = on ? 'block' : 'none';
  document.getElementById('mEditar').style.display = on ? 'none' : 'inline-flex';
}

/* monta a lista do datalist para a empresa */
function rebuildIngDatalist(empresa){
  const dl = document.getElementById('dlIng');
  const lista = (ING_TODOS||[]).filter(x=> !empresa || norm(x.empresa)===norm(empresa));
  dl.innerHTML = lista.map(x=>{
    const cod = x.codigo ? String(x.codigo) : '';
    const um  = (x.um||'').toUpperCase();
    const preco = fmtBRL(Number(x.custoUnit||0));
    return `<option value="${hEsc(x.nome)} ‚Äî ${hEsc(cod)}">${hEsc(x.nome)} ‚Ä¢ ${hEsc(cod)} ‚Ä¢ ${um} ‚Ä¢ ${preco}</option>`;
  }).join('');
}

/* tenta achar ingrediente por nome ou por c√≥digo */
function lookupIng(empresa, textNome, textCodigo){
  const nomeRaw = String(textNome||'').split('‚Äî')[0].trim();
  const codigo  = String(textCodigo||'').trim();
  const cand = (ING_TODOS||[]).filter(x=> !empresa || norm(x.empresa)===norm(empresa));
  if(codigo){
    const byCode = cand.find(x=> String(x.codigo||'').trim()===codigo);
    if(byCode) return byCode;
  }
  if(nomeRaw){
    const byName = cand.find(x=> norm(x.nome)===norm(nomeRaw));
    if(byName) return byName;
  }
  const codInNome = (String(textNome||'').includes('‚Äî')) ? String(textNome).split('‚Äî')[1].trim() : '';
  if(codInNome){
    const byCodeInName = cand.find(x=> String(x.codigo||'').trim()===codInNome);
    if(byCodeInName) return byCodeInName;
  }
  return null;
}

function fillEditForm(prod){
  document.getElementById('eItem').value   = prod.item || '';
  document.getElementById('eClass').value  = prod.classificacao || '';
  document.getElementById('eCodigo').value = prod.codigoSistema || '';
  document.getElementById('eNumero').value = prod.numero || '';
  document.getElementById('eRend').value   = (prod.rendimento ?? '');
  document.getElementById('eRendUM').value = (String(prod.unidadeRend||'un').toLowerCase());
  document.getElementById('eFoto').value   = prod.fotoUrl || prod.fotoId || '';
  document.getElementById('eUsuario').value = prod.usuario || '';

  rebuildIngDatalist(prod.empresa || EMPRESA_ATUAL || '');

  const tbody = document.getElementById('eTbody');
  tbody.innerHTML = '';
  const rec = Array.isArray(prod.receita) ? prod.receita : [];
  rec.forEach(r=> addIngRow(tbody, {
    item: r.item || '',
    codigo: r.codigo || '',
    qtd: Number(r.qtd ?? r.quantidade ?? r.qtdReceita ?? 0),
    um: String(r.um ?? r.unidade ?? r.unidadeReceita ?? 'un').toLowerCase()
  }));
}

/* constr√≥i linha de ingrediente */
function addIngRow(tbody, r={item:'', codigo:'', qtd:0, um:'un'}){
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input list="dlIng" value="${hEsc(r.item)}${r.codigo?(' ‚Äî '+hEsc(r.codigo)) : ''}" data-k="item" placeholder="Nome do ingrediente" /></td>
    <td><input value="${hEsc(r.codigo)}" data-k="codigo" placeholder="C√≥digo (opcional)" /></td>
    <td class="right"><input type="number" step="0.0001" value="${Number(r.qtd)||0}" data-k="qtd" style="text-align:right"/></td>
    <td>
      <select data-k="um">
        <option value="un"${r.um==='un'?' selected':''}>UN</option>
        <option value="g"${r.um==='g'?' selected':''}>G</option>
        <option value="kg"${r.um==='kg'?' selected':''}>KG</option>
        <option value="ml"${r.um==='ml'?' selected':''}>ML</option>
        <option value="l"${r.um==='l'?' selected':''}>L</option>
      </select>
    </td>
    <td>
      <button class="btn ghost eUp">‚¨Ü</button>
      <button class="btn ghost eDown">‚¨á</button>
      <button class="btn danger eDel">Excluir</button>
    </td>
  `;
  tbody.appendChild(tr);

  const empresaRef = CURRENT_PROD?.empresa || EMPRESA_ATUAL || '';
  const iNome = tr.querySelector('input[data-k="item"]');
  const iCod  = tr.querySelector('input[data-k="codigo"]');
  const iUM   = tr.querySelector('select[data-k="um"]');

  function autoFill(){
    const found = lookupIng(empresaRef, iNome.value, iCod.value);
    if(found){
      iNome.value = found.nome + (found.codigo ? ' ‚Äî ' + found.codigo : '');
      iCod.value  = found.codigo || '';
      if(found.um){ iUM.value = String(found.um).toLowerCase(); }
    }
  }
  iNome.addEventListener('change', autoFill);
  iNome.addEventListener('blur', autoFill);
  iCod.addEventListener('change', autoFill);
  iCod.addEventListener('blur', autoFill);

  tr.querySelector('.eDel').onclick = ()=> tr.remove();
  tr.querySelector('.eUp').onclick = ()=>{
    const prev = tr.previousElementSibling;
    if(prev) tbody.insertBefore(tr, prev);
  };
  tr.querySelector('.eDown').onclick = ()=>{
    const next = tr.nextElementSibling;
    if(next) tbody.insertBefore(next, tr);
  };
}

document.getElementById('eAddIng').addEventListener('click', ()=>{
  addIngRow(document.getElementById('eTbody'));
});

document.getElementById('eRecalc').addEventListener('click', ()=>{
  const preview = collectEditData(CURRENT_PROD);
  document.getElementById('mTitulo').textContent = preview.item || '';
  document.getElementById('mSub').textContent = `${preview.classificacao||''} ‚Ä¢ Empresa base: ${preview.empresa||CURRENT_PROD.empresa||''} ‚Ä¢ N¬∫ ${preview.numero||''}`;
  const fotoEl = document.getElementById('mFoto');
  const fotoSrc = driveImgSrc(preview.fotoUrl || preview.fotoId, 800);
  if(fotoSrc){ fotoEl.onerror=()=>{fotoEl.style.display='none'}; fotoEl.src=fotoSrc; fotoEl.style.display='block'; }
  alert('Recalcular: cabe√ßalho/miniatura atualizados. Custos detalhados s√£o recalculados ao salvar ou reabrir.');
});

function collectEditData(orig){
  const e = (id)=> document.getElementById(id);
  const data = {
    empresa: orig.empresa || EMPRESA_ATUAL || '',
    codigoSistema: e('eCodigo').value.trim(),
    numero: e('eNumero').value.trim(),
    item: e('eItem').value.trim(),
    classificacao: e('eClass').value.trim(),
    rendimento: Number(e('eRend').value||0),
    unidadeRend: e('eRendUM').value,
    usuario: e('eUsuario').value.trim(),
    fotoUrl: e('eFoto').value.trim(),
    receita: []
  };
  const rows = Array.from(document.querySelectorAll('#eTbody tr'));
  rows.forEach(tr=>{
    const get = (sel)=> tr.querySelector(sel);
    let itemRaw = (get('input[data-k="item"]').value||'').trim();
    const codigo = (get('input[data-k="codigo"]').value||'').trim();
    if(itemRaw.includes('‚Äî')) itemRaw = itemRaw.split('‚Äî')[0].trim();
    const qtd = Number(get('input[data-k="qtd"]').value||0);
    const um = get('select[data-k="um"]').value;
    if(itemRaw || codigo){
      data.receita.push({ item: itemRaw, codigo, qtd, um });
    }
  });
  data.data = orig.data || '';
  data.custoReceita = orig.custoReceita || 0;
  data.custoPorKgOuL = orig.custoPorKgOuL || 0;
  data.fotoId = data.fotoUrl;
  return data;
}

/* SALVAR */
document.getElementById('eSalvar').addEventListener('click', async ()=>{
  if(!CURRENT_PROD) return;
  const payload = collectEditData(CURRENT_PROD);

  if(!payload.item){ alert('Informe o nome da receita.'); return; }
  if(!payload.empresa){ alert('Defina a empresa (use o filtro antes de abrir).'); return; }

  const btn = document.getElementById('eSalvar');
  const old = btn.textContent;
  btn.disabled = true; btn.textContent = 'Salvando...';

  try{
    const res = await apiPost('?action=salvar_receita', { receita: payload, usuario: payload.usuario || '', original: {
      empresa: CURRENT_PROD.empresa || '',
      codigoSistema: CURRENT_PROD.codigoSistema || '',
      numero: CURRENT_PROD.numero || '',
      item: CURRENT_PROD.item || ''
    }});
    if(!res || res.ok===false) throw new Error(res?.error || 'Falha ao salvar');

    const idx = (PRODUTOS||[]).findIndex(p =>
      (payload.codigoSistema && p.codigoSistema===payload.codigoSistema) ||
      (p.numero && payload.numero && p.numero===payload.numero) ||
      (p.item && payload.item && norm(p.item)===norm(payload.item) && norm(p.empresa)===norm(payload.empresa))
    );
    const novo = {...CURRENT_PROD, ...payload};
    if(idx>=0) PRODUTOS[idx] = novo; else PRODUTOS.unshift(novo);
    CURRENT_PROD = structuredClone(novo);

    setEditMode(false);
    renderTabela();
    await abrirModal(novo);

    alert('Receita salva com sucesso ‚úÖ');
  }catch(err){
    console.error(err);
    alert('N√£o foi poss√≠vel salvar: '+ err.message);
  }finally{
    btn.disabled = false; btn.textContent = old;
  }
});

/* ====== EXCLUIR RECEITA (com senha) ====== */
document.getElementById('mExcluir').addEventListener('click', async ()=>{
  if(!CURRENT_PROD) return;
  const k = CURRENT_PROD;
  const msg = `Tem certeza que deseja EXCLUIR a receita?\n\nEmpresa: ${k.empresa}\nItem: ${k.item}\nC√≥digo: ${k.codigoSistema||'-'} ‚Ä¢ N¬∫: ${k.numero||'-'}`;
  if(!confirm(msg)) return;

  const senha = prompt('Digite a senha de exclus√£o:');
  if(senha===null) return; // cancelou
  const usuario = prompt('Informe seu nome (para registrar no hist√≥rico):') || '';

  const btn = document.getElementById('mExcluir');
  const old = btn.textContent;
  btn.disabled = true; btn.textContent = 'Excluindo...';

  try{
    const res = await apiPost('?action=excluir_produto', {
      empresa: k.empresa || '',
      codigoSistema: k.codigoSistema || '',
      numero: k.numero || '',
      item: k.item || '',
      senha,
      usuario
    });
    if(!res || !res.ok) throw new Error(res?.error || 'Falha ao excluir');

    // remove localmente
    PRODUTOS = (PRODUTOS||[]).filter(p=>{
      const sameEmp = norm(p.empresa)===norm(k.empresa);
      const byCod = k.codigoSistema && p.codigoSistema===k.codigoSistema;
      const byNum = k.numero && p.numero===k.numero;
      const byItem= k.item && norm(p.item)===norm(k.item);
      return !(sameEmp && (byCod || byNum || byItem));
    });

    modal.style.display='none';
    setEditMode(false);
    renderTabela();
    alert('Receita exclu√≠da com sucesso üóëÔ∏è');
  }catch(err){
    console.error(err);
    alert('N√£o foi poss√≠vel excluir: '+ err.message);
  }finally{
    btn.disabled = false; btn.textContent = old;
  }
});

/* ===== HIST√ìRICO ===== */
const histModal = document.getElementById('histModal');
document.getElementById('hFechar').addEventListener('click', ()=> histModal.style.display='none');
document.getElementById('btnHistorico').addEventListener('click', abrirHistorico);

async function abrirHistorico(){
  const hEmp = document.getElementById('hEmpresa');
  hEmp.innerHTML = '<option value="">(Todas)</option>' + EMPRESAS.map(e=>`<option value="${e}">${e}</option>`).join('');

  const dAte = new Date();
  const dDe  = new Date(); dDe.setDate(dAte.getDate()-30);
  const iso = d => d.toISOString().slice(0,10);
  document.getElementById('hDe').value = iso(dDe);
  document.getElementById('hAte').value = iso(dAte);

  await carregarHistorico();
  aplicarFiltroHistorico();
  histModal.style.display='flex';
}
async function carregarHistorico(){
  HIST = []; HIST_LINK = '';
  try{
    const j = await apiGet('?action=historico&ts='+Date.now());
    if(j && j.ok && Array.isArray(j.data)){
      HIST = j.data;
      document.getElementById('hFallback').style.display='none';
      return;
    }
  }catch(_){}
  try{
    const j2 = await apiGet('?action=historico_link&ts='+Date.now());
    if(j2 && j2.ok && j2.url){
      HIST_LINK = j2.url;
      document.getElementById('hFallback').style.display='block';
      document.getElementById('hAbrirPlanilha').onclick = ()=> window.open(HIST_LINK,'_blank');
      document.getElementById('hInfo').textContent = 'Exibindo fallback: abra o hist√≥rico completo no Google Sheets.';
      return;
    }
  }catch(_){}
  document.getElementById('hInfo').textContent = 'N√£o foi poss√≠vel carregar o hist√≥rico.';
  document.getElementById('hFallback').style.display='none';
}
function aplicarFiltroHistorico(){
  const tbody = document.getElementById('hTbody');
  tbody.innerHTML = '';
  if(!HIST.length){
    if(HIST_LINK){ /* s√≥ fallback */ }
    return;
  }
  const vDe  = document.getElementById('hDe').value ? new Date(document.getElementById('hDe').value) : null;
  const vAte = document.getElementById('hAte').value ? new Date(document.getElementById('hAte').value) : null;
  if(vAte) vAte.setHours(23,59,59,999);
  const vEmp = norm(document.getElementById('hEmpresa').value);
  const vBus = norm(document.getElementById('hBusca').value);

  const arr = HIST.filter(r=>{
    const d = parseBRDateTime(r.Timestamp||r.timestamp||'');
    if(vDe && d && d < vDe) return false;
    if(vAte && d && d > vAte) return false;
    const empOk = !vEmp || norm(r.Empresa||r.empresa||'')===vEmp || norm(String(r.Chave||'')).startsWith(vEmp+'::');

    const bOk = !vBus || [
      r.Chave, r.Usuario, r.Acao, r.Entidade,
      (r['Depois(JSON)']||r.Depois||r.DepoisJSON||''),
      (r['Antes(JSON)'] ||r.Antes ||r.AntesJSON ||''),
      (r['Diff(JSON)']  ||r.diff   ||r.diffJson   ||'')
    ].some(v=> String(v||'').toLowerCase().includes(vBus));

    return empOk && bOk;
  });

  arr.forEach(r=>{
    const d = r.Timestamp || r.timestamp || '';

    const diffStr   = (r['Diff(JSON)']  || r.diff   || r.diffJson   || '').toString();
    const depoisStr = (r['Depois(JSON)']|| r.Depois || r.DepoisJSON || '').toString();
    const antesStr  = (r['Antes(JSON)'] || r.Antes  || r.AntesJSON  || '').toString();

    const diffObj   = hTryParseJSON(diffStr);
    const depoisObj = hTryParseJSON(depoisStr);
    const antesObj  = hTryParseJSON(antesStr);

    const resumoHTML = hResumoAlteracoes(diffObj, antesObj, depoisObj);

    const detalhesHTML = `
      <details>
        <summary>ver</summary>
        ${resumoHTML}
        <div style="display:grid;gap:8px;margin-top:6px">
          <div>
            <div class="small muted">Depois (JSON)</div>
            <pre style="white-space:pre-wrap;font-size:.8rem">${hEsc(depoisObj ? hPretty(depoisObj) : depoisStr)}</pre>
          </div>
          <div>
            <div class="small muted">Antes (JSON)</div>
            <pre style="white-space:pre-wrap;font-size:.8rem">${hEsc(antesObj ? hPretty(antesObj) : antesStr)}</pre>
          </div>
        </div>
      </details>
    `;

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${d}</td>
      <td>${r.Usuario||r.usuario||''}</td>
      <td>${r.Entidade||r.entidade||''}</td>
      <td>${r.Acao||r.acao||''}</td>
      <td>${r.Chave||r.chave||''}</td>
      <td>${detalhesHTML}</td>
    `;
    tbody.appendChild(tr);
  });

  document.getElementById('hInfo').textContent = `${arr.length} registros encontrados`;
}
['hDe','hAte','hEmpresa','hBusca'].forEach(id=>{
  document.getElementById(id).addEventListener('input', aplicarFiltroHistorico);
});

/* ===== BOOT ===== */
async function boot(){
  const btn = document.getElementById('btnAtualizar');
  btn.disabled = true; btn.textContent = 'Carregando...';
  await carregarEmpresas();
  await carregarDados();
  renderEmpresasSelect();
  renderTabela();
  btn.disabled = false; btn.textContent = 'Atualizar';
}
document.getElementById('btnAtualizar').addEventListener('click', async ()=>{
  const btn = document.getElementById('btnAtualizar');
  btn.disabled = true; btn.textContent = 'Atualizando...';
  await carregarEmpresas();
  await carregarDados();
  renderEmpresasSelect();
  renderTabela();
  btn.disabled = false; btn.textContent = 'Atualizar';
});
document.getElementById('fEmpresa').addEventListener('change', ()=>{
  renderTabela();
  if(editBlk.style.display==='block'){
    rebuildIngDatalist(document.getElementById('fEmpresa').value || (CURRENT_PROD?.empresa||''));
  }
});
document.getElementById('fBusca').addEventListener('input', renderTabela);
boot();
</script>
</body>
</html>
