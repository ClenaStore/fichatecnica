<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<!-- impede zoom + melhora viewport em celular -->
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<meta name="format-detection" content="telephone=no" />
<title>RelatÃ³rios e AnÃ¡lises</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{
    --bg:#0f0f10; --panel:#141414; --line:#2a2a2a; --text:#f0f0f0; --muted:#cfcfcf;
    --brand:#2563eb; --accent:#b75507; --ok:#16a34a; --warn:#f59e0b; --danger:#ef4444;
    --radius:14px;
  }

  /* Base */
  *{ box-sizing:border-box }
  html, body{ height:100% }
  body{
    font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background:var(--bg); color:var(--text);
    margin:0; padding:24px;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    -webkit-text-size-adjust:100%;      /* evita zoom de texto no iOS */
    touch-action:manipulation;          /* evita double-tap zoom */
  }
  a, button{ -webkit-tap-highlight-color: transparent; }

  /* Header fixo no topo em mobile */
  header{
    position:sticky; top:0; z-index:20;
    background:linear-gradient(180deg, rgba(15,15,16,.98), rgba(15,15,16,.88));
    backdrop-filter:saturate(140%) blur(6px);
    border-bottom:1px solid rgba(255,255,255,.06);
    margin:-24px -24px 24px; padding:14px 24px;
    display:flex; justify-content:space-between; align-items:center; gap:12px;
  }
  h1{margin:0;font-size:clamp(1.05rem, 0.9rem + 1vw, 1.5rem);line-height:1.15;font-weight:700}

  /* BotÃµes */
  .btn{
    padding:12px 16px;border:none;border-radius:12px;cursor:pointer;font-weight:700;
    transition:transform .15s ease, opacity .15s ease, box-shadow .15s ease;
    box-shadow:0 6px 14px rgba(0,0,0,.25);
    font-size:16px; /* evita zoom ao focar no iOS */
  }
  .btn:active{ transform:scale(.98) }
  .btn.back{background:var(--accent);color:#fff}

  /* Grid */
  .grid{
    display:grid;
    grid-template-columns:repeat(12,1fr);
    gap:20px;
    max-width:1200px;
    margin:0 auto;
  }
  .span-6{ grid-column: span 6 }
  .span-4{ grid-column: span 4 }
  .span-8{ grid-column: span 8 }
  .span-12{ grid-column: span 12 }

  /* Cards */
  .card{
    background:var(--panel);border:1px solid var(--line);
    border-radius:var(--radius);padding:16px;
    box-shadow:0 10px 30px rgba(0,0,0,.35);
  }
  .card h2{font-size:1.05rem;margin:0 0 10px}
  .muted{ color:var(--muted) }
  .pill{ display:inline-block; padding:6px 10px; border-radius:999px; border:1px solid var(--line); background:#0d0d0e; font-size:.84rem }

  /* GrÃ¡ficos responsivos */
  .chart-box{ position:relative; width:100%; height:260px }
  .chart-box.tall{ height:300px }

  /* Tabelas */
  .table-wrap{ overflow:auto; border:1px solid var(--line); border-radius:10px }
  table{min-width:600px; width:100%; border-collapse:collapse}
  th,td{padding:10px 12px;border:1px solid var(--line);font-size:.95rem;text-align:left}
  th{background:#fff;color:#000;font-weight:700}
  tr.is-high td{ background: rgba(239,68,68,.12) }
  tr.is-mid  td{ background: rgba(245,158,11,.12) }

  /* Responsivo */
  @media (max-width: 1200px){
    .grid{ grid-template-columns:repeat(8,1fr) }
    .span-6{ grid-column: span 8 }
    .span-4{ grid-column: span 4 }
    .span-8{ grid-column: span 8 }
  }
  @media (max-width: 1024px){
    body{ padding:18px }
    header{ margin:-18px -18px 18px; padding:12px 18px }
    .grid{ grid-template-columns:repeat(6,1fr) }
    .span-6, .span-8{ grid-column: span 6 }
    .span-4{ grid-column: span 6 }
    .btn{ min-height:44px }
    .chart-box{ height:260px }
  }
  @media (max-width: 768px){
    body{ padding:12px; padding-bottom: max(12px, env(safe-area-inset-bottom)) }
    header{ margin:-12px -12px 12px; padding:10px 12px; gap:10px; }
    .grid{ grid-template-columns:1fr; gap:14px }
    .span-6, .span-4, .span-8, .span-12{ grid-column: span 1 }
    .card{ padding:14px; border-radius:16px }
    .btn{ width:100%; border-radius:14px }
    th,td{ white-space:nowrap; font-size:.98rem }
    .chart-box{ height:280px }
  }

  /* Inputs (evita zoom no foco em iOS) */
  input, select, textarea, button{ font-size:16px }

  /* Scrollbar sutil (Android/desktop) */
  ::-webkit-scrollbar{ height:8px; width:8px }
  ::-webkit-scrollbar-thumb{ background:#2b2b2b; border-radius:8px }
  ::-webkit-scrollbar-track{ background:#141414 }
</style>
</head>
<body>

<header>
  <h1>RelatÃ³rios e AnÃ¡lises</h1>
  <button class="btn back" onclick="window.location.href='index.analise.html'">â¬… Voltar</button>
</header>

<div class="grid">

  <!-- 1. Quantidade / Custos das Receitas -->
  <div class="card span-6">
    <h2>ðŸ“Œ Custo das Receitas</h2>
    <div class="chart-box">
      <canvas id="chartReceitas" aria-label="GrÃ¡fico de custos das receitas" role="img"></canvas>
    </div>
    <div id="resumoReceitas" style="margin-top:10px;font-size:.95rem">
      <span class="pill">Total de receitas: <b id="totalReceitas">0</b></span>
    </div>
  </div>

  <!-- 2. Produtos com custos diferentes -->
  <div class="card span-6">
    <h2>ðŸ’° Produtos com Custos Muito Diferentes</h2>
    <div class="table-wrap" role="region" aria-label="Tabela de variaÃ§Ã£o de custos">
      <table>
        <thead>
          <tr>
            <th>Produto</th>
            <th>Custo MÃ­n.</th>
            <th>Custo MÃ¡x.</th>
            <th>VariaÃ§Ã£o</th>
          </tr>
        </thead>
        <tbody id="tblProdutos"></tbody>
      </table>
    </div>
    <div class="muted" style="margin-top:8px;font-size:.9rem">
      Itens destacados tÃªm variaÃ§Ã£o acima do limite configurado.
    </div>
  </div>

  <!-- 3. Ingredientes com variaÃ§Ã£o alta -->
  <div class="card span-4">
    <h2>ðŸ¥— DiferenÃ§a de Custo por Ingrediente</h2>
    <div class="chart-box tall">
      <canvas id="chartIngredientes" aria-label="GrÃ¡fico de pizza com diferenÃ§as por ingrediente" role="img"></canvas>
    </div>
  </div>

  <!-- 4. AnÃ¡lise Detalhada -->
  <div class="card span-8">
    <h2>ðŸ”Ž AnÃ¡lise Detalhada</h2>
    <div class="table-wrap" role="region" aria-label="Tabela de anÃ¡lise detalhada">
      <table>
        <thead>
          <tr>
            <th>Receita</th>
            <th>Qtd. Ingredientes</th>
            <th>Custo Total</th>
            <th>Custo MÃ©dio</th>
          </tr>
        </thead>
        <tbody id="tblDetalhada"></tbody>
      </table>
    </div>
  </div>

</div>

<script>
/* ========= Helpers ========= */
const fmtBRL = n => (Number(n)||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});

/* ========= Dados mockados (trocar pelo Apps Script quando quiser) ========= */
const receitas = [
  {nome:"Bolo Chocolate", qtdIng:5, custo:45},
  {nome:"PÃ£o FrancÃªs",    qtdIng:3, custo:25},
  {nome:"Pizza Mussarela",qtdIng:6, custo:60},
  {nome:"Torta Frango",   qtdIng:7, custo:55},
];

const produtos = [
  {nome:"Farinha", min:4.5, max:7.0},
  {nome:"Leite",   min:3.2, max:5.5},
  {nome:"Ovo",     min:0.4, max:0.9},
];

/* ========= 1. Custo das Receitas (bar + linha) ========= */
document.getElementById("totalReceitas").innerText = receitas.length;

const ctx1 = document.getElementById("chartReceitas");
new Chart(ctx1, {
  type:"bar",
  data:{
    labels:receitas.map(r=>r.nome),
    datasets:[
      {
        label:"Custo (R$)",
        data:receitas.map(r=>r.custo),
        backgroundColor:"#2563eb"
      },
      {
        label:"Qtd. ingredientes",
        data:receitas.map(r=>r.qtdIng),
        type:"line",
        borderColor:"#f59e0b",
        borderWidth:2,
        pointRadius:3,
        fill:false,
        yAxisID:'y2'
      }
    ]
  },
  options:{
    responsive:true,
    maintainAspectRatio:false,
    layout:{ padding:{ top:0, right:6, bottom:0, left:0 } },
    plugins:{
      legend:{ labels:{ color:"#e5e7eb" } },
      tooltip:{
        callbacks:{
          label:(c)=> c.datasetIndex===0
            ? `${c.label}: ${fmtBRL(c.parsed.y)}`
            : `${c.label}: ${c.parsed.y}`
        }
      }
    },
    scales:{
      x:{ ticks:{ color:"#cbd5e1" }, grid:{ color:"rgba(255,255,255,.06)" } },
      y:{
        ticks:{ color:"#cbd5e1" },
        grid:{ color:"rgba(255,255,255,.06)" },
        title:{ display:true, text:"Custo (R$)", color:"#cbd5e1" }
      },
      y2:{
        position:'right',
        grid:{ display:false },
        ticks:{ color:"#fbbf24" },
        title:{ display:true, text:"Qtd. ingredientes", color:"#fbbf24" }
      }
    }
  }
});

/* ========= 2. Produtos com custos diferentes ========= */
const tbodyP = document.getElementById("tblProdutos");
const limiteAbs = 2.0;   // R$
const limitePerc = 0.35; // 35%

const produtosOrdenados = [...produtos].sort((a,b)=>(b.max-b.min)-(a.max-a.min));
produtosOrdenados.forEach(p=>{
  const variacaoAbs  = (p.max - p.min);
  const variacaoPerc = p.min>0 ? (variacaoAbs / p.min) : 0;
  const cls = variacaoPerc >= 0.6 || variacaoAbs >= 5 ? 'is-high'
            : (variacaoPerc >= limitePerc || variacaoAbs >= limiteAbs) ? 'is-mid' : '';

  const tr = document.createElement('tr');
  if(cls) tr.classList.add(cls);
  tr.innerHTML = `
    <td>${p.nome}</td>
    <td>${fmtBRL(p.min)}</td>
    <td>${fmtBRL(p.max)}</td>
    <td>${fmtBRL(variacaoAbs)} (${(variacaoPerc*100).toFixed(0)}%)</td>
  `;
  tbodyP.appendChild(tr);
});

/* ========= 3. DiferenÃ§a por Ingrediente (pizza) ========= */
const diffs = produtos.map(p=>Math.max(0,(p.max-p.min)));
const labelsIng = produtos.map(p=>p.nome);
const palette = ["#2563eb","#f59e0b","#ef4444","#10b981","#a78bfa","#f97316","#22c55e","#eab308","#3b82f6","#f43f5e"];
const colors = labelsIng.map((_,i)=>palette[i % palette.length]);

const ctx2 = document.getElementById("chartIngredientes");
new Chart(ctx2, {
  type:"pie",
  data:{
    labels: labelsIng,
    datasets:[{
      data: diffs,
      backgroundColor: colors,
      borderColor: "rgba(0,0,0,.25)",
      borderWidth: 1
    }]
  },
  options:{
    responsive:true,
    maintainAspectRatio:false,
    plugins:{
      legend:{ position:'bottom', labels:{ color:"#e5e7eb" } },
      tooltip:{ callbacks:{ label:(c)=>`${c.label}: ${fmtBRL(c.parsed)}` } }
    }
  }
});

/* ========= 4. AnÃ¡lise detalhada ========= */
const tbodyD = document.getElementById("tblDetalhada");
receitas.forEach(r=>{
  const custoMedio = r.qtdIng>0 ? (r.custo/r.qtdIng) : 0;
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td>${r.nome}</td>
    <td>${r.qtdIng}</td>
    <td>${fmtBRL(r.custo)}</td>
    <td>${fmtBRL(custoMedio)}</td>
  `;
  tbodyD.appendChild(tr);
});
</script>

</body>
</html>
