<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Análise de Custos & Formação de Preço</title>
<style>
  :root{
    --bg:#0f0f10; --panel:#141414; --line:#2a2a2a; --text:#f0f0f0; --muted:#cfcfcf;
    --brand:#2563eb; --ghost:#374151; --white:#fff;
    --gold-dark:#7a5f00; --gold-edge:#caa43a;
    --ok:#10b981; --err:#ef4444; --ink:#111;
  }
  *{ box-sizing:border-box }
  body{ font-family:Arial,Helvetica,sans-serif; background:var(--bg); color:var(--text); margin:0; padding:24px }
  h1{ margin:0 0 6px }
  .muted{ color:var(--muted) }
  .right{ text-align:right }

  /* Banner de status */
  #netBanner{ display:none; margin-bottom:10px; padding:10px 12px; border-radius:10px; border:1px solid #3a3a3a }
  #netBanner.err{ display:block; background:#1a1111; color:#ffd6d6; border-color:#5a2a2a }

  .card{ background:var(--panel); border:1px solid var(--line); border-radius:14px; padding:16px; margin-bottom:16px; box-shadow:0 4px 20px rgba(0,0,0,.3) }
  .row{ display:grid; grid-template-columns:repeat(12,1fr); gap:12px }
  label{ font-size:.95rem; color:var(--muted) }
  select, input[type="text"], input[type="number"]{ width:100%; padding:12px; border-radius:10px; border:1px solid #333; background:#0f0f10; color:#fff }
  .btn{ cursor:pointer; border:0; border-radius:12px; padding:10px 14px; background:var(--brand); color:#fff }
  .btn.secondary{ background:#334155 }
  .btn.ghost{ background:transparent; border:1px solid var(--ghost); color:#fff }
  .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:12px }
  .mini{ padding:6px 10px; border-radius:10px }
  .pill{ padding:6px 10px; border-radius:999px; border:1px solid var(--ghost); background:#111; font-size:.9rem }
  .stat{ display:flex; gap:10px; flex-wrap:wrap }
  .stat .pill strong{ color:#fff }

  table{ width:100%; border-collapse:collapse }
  th,td{ border:1px solid var(--line); padding:8px; text-align:left; white-space:nowrap }
  th{ background:#fff; color:#000; font-weight:700 }
  td.right, th.right{ text-align:right }
  .tbl-wrap{ overflow:auto; border-radius:10px }

  .kpi{ display:grid; grid-template-columns:repeat(4,1fr); gap:10px }
  .kpi .box{ background:#101014; border:1px solid var(--line); border-radius:12px; padding:12px }
  .kpi .val{ font-weight:800; font-size:1.2rem }

  .cost-row{ display:grid; grid-template-columns:150px 130px 1fr 180px; gap:10px; align-items:center }
  .cost-row .mode{ display:flex; gap:6px }
  .hr{ height:1px; background:var(--line); margin:10px 0 }
  .warn{ color:#ffd78a; font-size:.9rem }

  /* Typeahead */
  .ta-wrap{ position:relative }
  .ta-list{ position:absolute; top:100%; left:0; right:0; background:#0f0f10; border:1px solid var(--line); border-radius:10px; box-shadow:0 10px 30px rgba(0,0,0,.45); max-height:260px; overflow:auto; display:none; z-index:20 }
  .ta-item{ padding:10px 12px; border-bottom:1px solid #1b1b1b; cursor:pointer }
  .ta-item:last-child{ border-bottom:none }
  .ta-item:hover, .ta-item.active{ background:#1b1b1b }
  .ta-title{ font-weight:700; color:#fff }
  .ta-meta{ font-size:.85rem; color:#a3a3a3; margin-left:6px }

  /* ===== BLOCO "Formação de preço" — dourado escuro com letras brancas GRANDES ===== */
  #cardVenda{ background:linear-gradient(180deg, var(--gold-dark) 0%, #5d4500 100%) !important; color:#fff !important; border:1px solid var(--gold-edge) !important }
  #cardVenda label, #cardVenda .muted, #cardVenda .warn{ color:#fff !important }
  #cardVenda .kpi .box{ background:rgba(0,0,0,.18) !important; border:1px solid rgba(255,255,255,.28) !important }
  #cardVenda .kpi .val{ color:#fff !important; font-size:1.45rem; letter-spacing:.2px }
  #cardVenda input{ background:rgba(0,0,0,.22) !important; color:#fff !important; border:1px solid rgba(255,255,255,.45) !important }
  #cardVenda input::placeholder{ color:rgba(255,255,255,.9) }
  #cardVenda strong, #cardVenda .grid-2 > strong{ font-size:1.35rem; color:#fff; letter-spacing:.3px }
  #actionsWrap{ display:flex; gap:10px; justify-content:flex-end; align-items:flex-end; flex-direction:column }
  #btnSalvarPainel{ align-self:flex-end }

  /* ===== Detalhes de compostos (mesmo layout da tabela) ===== */
  .det-toggle{ font-size:.85rem; margin-left:6px; color:#60a5fa; cursor:pointer; border:1px solid #26476b; padding:2px 6px; border-radius:8px; background:#0f172a }
  .detail-row{ display:none; background:#0d0d0f }
  .detail-row td{ border-top:none; border-bottom:1px dashed #2b2b2b }
  .detail-inner{ padding:10px }
  .detail-inner table{ width:100% }
  .detail-inner th, .detail-inner td{ background:transparent; color:#ddd; border-color:#2b2b2b }
  .detail-title{ font-weight:700; color:#fff; margin-bottom:4px }

  /* ===== RELATÓRIO (só no PRINT) ===== */
  #report{ display:none }
  #repHeader{ display:flex; align-items:center; justify-content:space-between; margin-bottom:10px; padding-bottom:10px; border-bottom:2px solid #000 }
  #repLogo{ width:180px; height:64px; display:block }
  #repLogo img{ max-width:100%; max-height:100%; display:block }
  #repTitle{ font-weight:800; font-size:1.2rem; color:#000 }
  #repMeta{ color:#333; font-size:.9rem }
  #repGrid{ display:grid; grid-template-columns:1fr; gap:10px }
  #report table{ border-color:#000 }
  #report th{ background:#000; color:#fff }

  @media print{
    @page{ size:A4; margin:12mm }
    body{ background:#fff; color:#000; padding:0 }
    .card, .ta-list, .btn, .row-actions, #netBanner{ display:none !important }
    #report{ display:block }
    #report .tbl-wrap{ overflow:visible }
  }

  @media (max-width: 980px){
    .row{ grid-template-columns:1fr 1fr }
    .kpi{ grid-template-columns:1fr 1fr }
    .cost-row{ grid-template-columns:1fr 120px 1fr 150px }
    #cardVenda .kpi .val{ font-size:1.25rem }
    #actionsWrap{ align-items:stretch }
  }
  @media (max-width: 640px){
    body{ padding:14px }
    .row{ grid-template-columns:1fr }
    .kpi{ grid-template-columns:1fr }
    .cost-row{ grid-template-columns:1fr 1fr }
  }
</style>
</head>
<body>

  <div id="netBanner" class="err"></div>

  <h1>Análise de Custos & Formação de Preço</h1>

  <!-- Filtros -->
  <div class="card">
    <div class="row">
      <div style="grid-column:span 3">
        <label>Empresa</label>
        <select id="empresa"></select>
        <div class="muted" id="infoEmpresa"></div>
      </div>

      <!-- Busca única (nome/código) com autocomplete -->
      <div style="grid-column:span 9" class="ta-wrap">
        <label>Produto (busca por nome/código)</label>
        <input id="busca" type="text" placeholder="Ex.: Bolo, 102, P-001..." autocomplete="off">
        <div id="ta_list" class="ta-list"></div>
      </div>

      <div style="grid-column:span 4">
        <label>Usuário (opcional)</label>
        <input id="usuario" type="text" placeholder="Seu nome/login">
      </div>
    </div>
    <div class="row-actions" style="margin-top:10px">
      <button class="btn secondary" id="btnReload">Recarregar</button>
      <button class="btn ghost" id="btnPrint">Imprimir relatório</button>
      <a class="btn ghost" href="./">← Cadastro</a>
    </div>
  </div>

  <!-- Cabeçalho do produto -->
  <div class="card" id="cardProd" style="display:none">
    <div class="row">
      <div style="grid-column:span 6">
        <div class="muted">Produto</div>
        <div id="p_nome" style="font-size:1.1rem;font-weight:700">—</div>
        <div class="muted" id="p_meta">—</div>
      </div>
      <div style="grid-column:span 6">
        <div class="kpi">
          <div class="box"><div class="muted">Rendimento</div><div class="val" id="k_rend">—</div></div>
          <div class="box"><div class="muted">Custo da Receita</div><div class="val" id="k_custoRec">—</div></div>
          <div class="box"><div class="muted">Custo por g/ml</div><div class="val" id="k_custoGml">—</div></div>
          <div class="box"><div class="muted">Custo por kg/L</div><div class="val" id="k_custoKgL">—</div></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Receita -->
  <div class="card" id="cardRec" style="display:none">
    <div class="grid-2">
      <div><strong>Composição da receita</strong> <span class="muted">(subtotais recalculados)</span></div>
      <div class="right">
        <button class="btn ghost mini" id="btnCSV">Exportar CSV</button>
      </div>
    </div>
    <div class="tbl-wrap" style="margin-top:8px">
      <table id="tbl">
        <thead>
          <tr>
            <th>Item</th><th class="right">Qtd</th><th>U.M.</th><th class="right">Custo Unit. (R$)</th><th class="right">Subtotal (R$)</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
    <div class="stat" style="margin-top:8px">
      <span class="pill">Itens: <strong id="s_itens">0</strong></span>
      <span class="pill">Custo da Receita: <strong id="s_total">R$ 0,00</strong></span>
      <span class="pill">Custo por g/ml: <strong id="s_gml">R$ 0,0000</strong></span>
      <span class="pill">Custo por kg/L: <strong id="s_kgl">R$ 0,00</strong></span>
    </div>
  </div>

  <!-- Custos extras -->
  <div class="card" id="cardCusto" style="display:none">
    <div class="grid-2">
      <strong>Custos adicionais</strong>
      <div class="right"><span class="muted">(% aplicados sobre o custo da receita)</span></div>
    </div>
    <div class="hr"></div>

    <div class="cost-row">
      <div class="muted">Impostos</div>
      <div class="mode">
        <label><input type="radio" name="m_imp" value="pct" checked> %</label>
        <label><input type="radio" name="m_imp" value="abs"> R$</label>
      </div>
      <input id="v_imp" type="text" placeholder="Ex.: 12,5 ou 100,00">
      <div class="right"><span class="muted">Valor:</span> <strong id="r_imp">R$ 0,00</strong></div>
    </div>

    <div class="cost-row">
      <div class="muted">Despesa Fixa</div>
      <div class="mode">
        <label><input type="radio" name="m_fix" value="pct" checked> %</label>
        <label><input type="radio" name="m_fix" value="abs"> R$</label>
      </div>
      <input id="v_fix" type="text" placeholder="Ex.: 5 ou 80,00">
      <div class="right"><span class="muted">Valor:</span> <strong id="r_fix">R$ 0,00</strong></div>
    </div>

    <div class="cost-row">
      <div class="muted">Despesa Operacional</div>
      <div class="mode">
        <label><input type="radio" name="m_op" value="pct" checked> %</label>
        <label><input type="radio" name="m_op" value="abs"> R$</label>
      </div>
      <input id="v_op" type="text" placeholder="Ex.: 7,5 ou 50,00">
      <div class="right"><span class="muted">Valor:</span> <strong id="r_op">R$ 0,00</strong></div>
    </div>

    <div class="hr"></div>
    <div class="kpi">
      <div class="box"><div class="muted">Custo da Receita (lote)</div><div class="val" id="k_base">—</div></div>
      <div class="box"><div class="muted">Custos Adicionais</div><div class="val" id="k_add">—</div></div>
      <div class="box"><div class="muted">Custo Final (lote)</div><div class="val" id="k_final">—</div></div>
      <div class="box"><div class="muted" id="kf_label">Custo Final por —</div><div class="val" id="k_final_unit">—</div></div>
    </div>
  </div>

  <!-- Formação de preço (por Margem) -->
  <div class="card" id="cardVenda" style="display:none">
    <div class="grid-2">
      <strong>Formação de preço</strong>
      <div id="actionsWrap">
        <button class="btn" id="btnSalvarPainel">Salvar no Painel</button>
        <button class="btn ghost" id="btnClear">Limpar valores</button>
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <div style="grid-column:span 4">
        <label id="pv_label">Margem de lucro (%)</label>
        <input id="pv_input" type="text" placeholder="Ex.: 40">
        <div class="muted small" id="pv_hint">Base: —</div>
      </div>
      <div style="grid-column:span 8">
        <div class="kpi">
          <div class="box"><div class="muted">Preço de venda (lote)</div><div class="val" id="pv_lote">—</div></div>
          <div class="box"><div class="muted">Markup</div><div class="val" id="pv_markup">—</div></div>
          <div class="box"><div class="muted">Lucro (lote)</div><div class="val" id="pv_lucro">—</div></div>
        </div>
      </div>
    </div>
    <div class="warn" id="pv_warn" style="display:none;margin-top:8px">⚠ Valor inválido de margem.</div>
  </div>

  <!-- RELATÓRIO (mostrado só no print) -->
  <section id="report">
    <div id="repHeader">
      <div id="repLogo"><img id="repLogoImg" alt="LOGO"></div>
      <div style="text-align:right">
        <div id="repTitle">Relatório de composição e preço</div>
        <div id="repMeta" class="muted"></div>
      </div>
    </div>

    <div id="repGrid">
      <div>
        <strong>Produto</strong>
        <div id="repProd" style="margin-top:4px"></div>
      </div>

      <div class="tbl-wrap">
        <table>
          <thead>
            <tr>
              <th>Item</th><th class="right">Qtd</th><th>U.M.</th><th class="right">Custo Unit.</th><th class="right">Subtotal</th>
            </tr>
          </thead>
          <tbody id="repTbody"></tbody>
        </table>
      </div>

      <div style="display:grid; grid-template-columns:repeat(2,1fr); gap:10px">
        <div class="card" style="background:#fff;border:1px solid #000;color:#000">
          <div><strong>Custos</strong></div>
          <div style="margin-top:6px">
            <div>Custo Receita (lote): <span id="repBase"></span></div>
            <div>Custos Adicionais: <span id="repAdd"></span></div>
            <div><strong>Custo Final (lote): <span id="repFinal"></span></strong></div>
            <div id="repFinalUnitWrap">Custo Final por <span id="repFinalUnitLbl"></span>: <span id="repFinalUnit"></span></div>
          </div>
        </div>
        <div class="card" style="background:#fff;border:1px solid #000;color:#000">
          <div><strong>Preço</strong></div>
          <div style="margin-top:6px">
            <div>Margem aplicada: <span id="repMargem"></span></div>
            <div>Markup: <span id="repMarkup"></span></div>
            <div>Lucro (lote): <span id="repLucro"></span></div>
            <div><strong>Preço de venda (lote): <span id="repPV"></span></strong></div>
          </div>
        </div>
      </div>
    </div>
  </section>

<script>
/* ===== CONFIG ===== */
const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbwe_QlzOzFM7jExmSF0ftci2aL_Lw8xw73-0UdyCTi8KAQF4uwAjRopbx2dbkgXfXr6/exec';
const DEFAULT_EMPRESAS = ['Mercatto','Padaria'];
const LOGO_URL = ''; // ⬅️ coloque aqui a URL da sua LOGO (aparece apenas no relatório impresso)

/* ===== FORMATOS ===== */
const fmtBRL = v => (isNaN(v)?0:v).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
const FACTOR = { g:1, kg:1000, ml:1, l:1000, un:1 };
const TYPE   = u => (u==='g'||u==='kg')?'mass' : (u==='ml'||u==='l')?'vol' : 'count';
function convertQty(qty, from, to){
  from = (from||'').toLowerCase(); to = (to||'').toLowerCase();
  if(!FACTOR[from] || !FACTOR[to]) return qty; if(TYPE(from) !== TYPE(to)) return NaN;
  return qty * (FACTOR[from] / FACTOR[to]);
}
function toNumberBR(val){
  if (typeof val === 'number') return Number.isFinite(val) ? val : 0;
  if (val && val.nodeType === 1 && typeof val.value !== 'undefined') val = val.value;
  val = String(val ?? '').trim();
  const hasC = val.includes(','), hasD = val.includes('.');
  if (hasC && hasD) val = val.replace(/\./g,'').replace(',', '.');
  else if (hasC)    val = val.replace(',', '.');
  const n = parseFloat(val);
  return Number.isFinite(n) ? n : 0;
}
const norm = s => String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();

/* ===== ESTADO ===== */
let EMPRESAS=[], PRODUTOS=[], PROD=null;
let BASE = { total:0, gml:0, kgl:0, rendimento:0, unidade:'' };
let ADD = { imp:{mode:'pct', val:0}, fix:{mode:'pct', val:0}, op:{mode:'pct', val:0} };
let MARGEM = 0; // % desejada

/* ===== ELEMENTOS ===== */
const elEmpresa = document.getElementById('empresa');
const elBusca   = document.getElementById('busca');
const elTaList  = document.getElementById('ta_list');
const elTbody   = document.getElementById('tbody');

/* ===== BACKEND ===== */
async function fetchEmpresas(){
  try{
    const r = await fetch(WEBAPP_URL+'?action=empresas');
    const j = await r.json();
    EMPRESAS = (j.ok && Array.isArray(j.data) && j.data.length) ? j.data : DEFAULT_EMPRESAS.slice();
  }catch{ EMPRESAS = DEFAULT_EMPRESAS.slice(); banner('Não foi possível conectar ao servidor. Operando localmente.'); }
  elEmpresa.innerHTML = '';
  const o0 = document.createElement('option'); o0.value=''; o0.textContent='— selecione —'; elEmpresa.appendChild(o0);
  EMPRESAS.forEach(n=>{ const o=document.createElement('option'); o.value=n; o.textContent=n; elEmpresa.appendChild(o); });
}

async function fetchProdutos(empresa){
  const url = WEBAPP_URL+'?action=produtos&empresa='+encodeURIComponent(empresa||'')+'&ts='+Date.now();
  try{
    const r = await fetch(url, {cache:'no-store'});
    const j = await r.json();
    if(!j.ok) throw new Error(j.error||'erro');
    PRODUTOS = Array.isArray(j.data) ? j.data : [];
    document.getElementById('infoEmpresa').textContent = `Produtos: ${PRODUTOS.length}`;
  }catch(e){
    PRODUTOS = [];
    document.getElementById('infoEmpresa').textContent = 'Não foi possível carregar produtos.';
    banner('Falha ao carregar produtos: '+(e.message||e), true);
  }
  renderSugestoes();
  if(PRODUTOS.length){ // auto-seleciona 1º
    fillProduto(PRODUTOS[0]);
    elBusca.value = `${PRODUTOS[0].item||'(produto)'} — ${PRODUTOS[0].codigoSistema||'-'}`;
  }
}

async function fetchPrecoSalvo(prod){
  const params = new URLSearchParams({
    action:'preco_get', empresa: prod.empresa||'', codigo:  prod.codigoSistema||'', numero:  prod.numero||'', item:    prod.item||''
  });
  try{
    const r = await fetch(WEBAPP_URL+'?'+params.toString(), {cache:'no-store'});
    const j = await r.json();
    if(!j.ok || !j.data) return null; return j.data;
  }catch{ return null; }
}

async function salvarPrecoPainel(payload){
  try{
    const r = await fetch(WEBAPP_URL+'?action=salvar_precificacao', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    const txt = await r.text();
    try{ return JSON.parse(txt); }catch{ return {ok:false, error:'Resposta não-JSON: '+txt}; }
  }catch(e){ return {ok:false, error:String(e)} }
}

/* ===== BUSCA / TYPEAHEAD ===== */
let taActive = -1;
function buscar(q){
  const s = norm(q);
  if(!s) return [];
  return PRODUTOS.filter(p=>{
    const n = norm(p.item);
    const c1 = String(p.codigoSistema||'').toLowerCase();
    const c2 = String(p.numero||'').toLowerCase();
    return n.includes(s) || c1.includes(s) || c2.includes(s);
  }).slice(0,50);
}
function renderSugestoes(){
  const q = elBusca.value.trim();
  const list = buscar(q);
  if(!q || !list.length){ elTaList.style.display='none'; elTaList.innerHTML=''; taActive=-1; return; }
  elTaList.innerHTML = list.map(p=>{
    const idx = PRODUTOS.indexOf(p);
    const meta = [p.codigoSistema||'-', (p.numero ? ('Nº '+p.numero) : '')].filter(Boolean).join(' • ');
    return `<div class="ta-item" data-idx="${idx}"><span class="ta-title">${p.item||'(produto)'}</span><span class="ta-meta">— ${meta}</span></div>`;
  }).join('');
  elTaList.style.display='block';
  taActive = -1;
}
function selectByIndex(idxInProd){ if(!(idxInProd>=0) || !PRODUTOS[idxInProd]) return; const p = PRODUTOS[idxInProd]; elBusca.value = `${p.item||'(produto)'} — ${p.codigoSistema||'-'}`; elTaList.style.display='none'; fillProduto(p); }
elTaList.addEventListener('click', e=>{ const item = e.target.closest('.ta-item'); if(!item) return; selectByIndex(Number(item.dataset.idx)); });
function updateActive(){ const items = [...elTaList.querySelectorAll('.ta-item')]; items.forEach((el,i)=> el.classList.toggle('active', i===taActive)); if(items[taActive]) items[taActive].scrollIntoView({block:'nearest'}); }

/* ===== CÁLCULO DA RECEITA (com detalhes de compostos) ===== */
async function enriquecerComCompostos(prodClonado){
  const empresaSel = (prodClonado.empresa || document.getElementById('empresa').value || '').toLowerCase();
  for(const l of (prodClonado.receita||[])){
    const nome  = l.item || l.nome || '';
    const codigo= l.codigo || '';
    const qtd   = toNumberBR(l.qtd) || 1;
    const um    = (l.um||'').toLowerCase();
    const custoAtual = toNumberBR(l.custoUnit);
    if(!(nome||codigo)) continue;
    try{
      const qs = new URLSearchParams({ action:'comparar_ingrediente', nome, codigo, qtd, um });
      const r  = await fetch(WEBAPP_URL+'?'+qs.toString(), {cache:'no-store'});
      const j  = await r.json();
      if(!(j && j.ok && j.data && Array.isArray(j.data.empresas))) continue;
      const lista = j.data.empresas;
      let escolha = lista.find(x => (x.empresa||'').toLowerCase() === empresaSel) || lista[0];
      if(!escolha) continue;

      // Se custoUnit do item estiver vazio/zerado, preenche com o encontrado
      if(!(custoAtual>0) && (typeof escolha.custoUnit==='number')){
        l.custoUnit = escolha.custoUnit;
        l.priceUm   = (escolha.umPreco || l.um || 'kg');
      }
      // Se for composto, guarda detalhes + escala para quantidade da linha
      if(String(escolha.tipo||'')==='composto' && Array.isArray(escolha.comp)){
        const conv = toNumberBR(escolha.qtdConvertida||0) || convertQty(qtd, um, (escolha.umPreco||l.um||'').toLowerCase()) || 1;
        const filhos = escolha.comp.map(c=>({
          nome:c.nome||'', codigo:c.codigo||'', qtdComp:c.qtdComp||0, umComp:(c.umComp||'').toUpperCase(), custoUnit:Number(c.custoUnit||0),
          valorBase:Number(c.valor||0), valorLinha: Number((Number(c.valor||0)*conv).toFixed(6))
        }));
        l._compDet = { umPreco:(escolha.umPreco||l.um||'').toUpperCase(), conv, filhos, totalBase:Number(escolha.compTotal||0), totalLinha: Number((Number(escolha.compTotal||0)*conv).toFixed(6)) };
      }
    }catch(_){ /* ignora */ }
  }
}

function calcularReceita(prod){
  const linhas = Array.isArray(prod?.receita)? prod.receita : [];
  const itens = [];
  let total = 0;
  linhas.forEach((l,idx)=>{
    const qtd = toNumberBR(l.qtd);
    const umLinha = (l.um||'').toLowerCase();
    const umPreco = (l.priceUm||l.um||'').toLowerCase();
    const custo = toNumberBR(l.custoUnit);
    const conv = convertQty(qtd, umLinha, umPreco);
    const subtotal = (isNaN(conv)?0:conv) * (isNaN(custo)?0:custo);
    itens.push({ 
      _i: idx,
      item:l.item||l.nome||l.codigo||'(ing.)', qtd, um:umLinha.toUpperCase(), custoUnit:custo, subtotal,
      comp: l._compDet || null
    });
    total += subtotal;
  });

  const rend = toNumberBR(prod?.rendimento);
  const u = (prod?.unidadeRend||'').toLowerCase();
  let custoGml=0, custoKgL=0;
  const toBase = uu => uu==='kg' ? 1000 : uu==='l' ? 1000 : 1;
  if(['g','kg','ml','l'].includes(u) && rend>0){
    const emBase = rend * toBase(u);
    custoGml = total / emBase;
    custoKgL = total / (emBase/1000);
  }
  return { itens, total, gml:custoGml, kgl:custoKgL, rendimento:rend, unidade:u };
}

/* ===== ATUALIZA TELAS ===== */
async function fillProduto(prod){
  const prodEnri = JSON.parse(JSON.stringify(prod||{}));
  await enriquecerComCompostos(prodEnri);

  PROD = prodEnri;
  const calc = calcularReceita(prodEnri);
  BASE = calc;

  document.getElementById('p_nome').textContent = prodEnri.item || '(produto)';
  document.getElementById('p_meta').textContent = `${prodEnri.codigoSistema||'-'} • Nº ${prodEnri.numero||'-'} • ${prodEnri.classificacao||'-'}`;
  document.getElementById('k_rend').textContent = `${calc.rendimento||0} ${(calc.unidade||'').toUpperCase()}`;
  document.getElementById('k_custoRec').textContent = fmtBRL(calc.total);
  document.getElementById('k_custoGml').textContent = 'R$ ' + (calc.gml||0).toFixed(4).replace('.',',');
  document.getElementById('k_custoKgL').textContent = fmtBRL(calc.kgl);

  // Tabela + detalhes
  elTbody.innerHTML = '';
  calc.itens.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.item}${r.comp?` <button class="det-toggle" data-row="det_${r._i}">Detalhes</button>`:''}</td>
      <td class="right">${(r.qtd||0).toLocaleString('pt-BR')}</td>
      <td>${(r.um||'').toUpperCase()}</td>
      <td class="right">${fmtBRL(r.custoUnit)}</td>
      <td class="right">${fmtBRL(r.subtotal)}</td>`;
    elTbody.appendChild(tr);

    if(r.comp){
      const trd = document.createElement('tr');
      trd.className = 'detail-row'; trd.id = 'det_'+r._i;
      const inner = [`<td colspan="5"><div class="detail-inner">`];
      inner.push(`<div class="detail-title">Composto — preço por ${r.comp.umPreco} • fator do lote: ${ (r.comp.conv||1).toLocaleString('pt-BR') }</div>`);
      inner.push('<table><thead><tr><th>Ingrediente</th><th class="right">Qtd</th><th>U.M.</th><th class="right">Custo Unit.</th><th class="right">Subtotal (linha)</th></tr></thead><tbody>');
      r.comp.filhos.forEach(f=>{
        inner.push(`<tr><td>${f.nome}</td><td class="right">${(f.qtdComp||0).toLocaleString('pt-BR')}</td><td>${f.umComp}</td><td class="right">${fmtBRL(f.custoUnit)}</td><td class="right">${fmtBRL(f.valorLinha||0)}</td></tr>`);
      });
      inner.push(`</tbody><tfoot><tr><th colspan="4" class="right">Total componentes (linha)</th><th class="right">${fmtBRL(r.comp.totalLinha||0)}</th></tr></tfoot></table>`);
      inner.push(`</div></td>`);
      trd.innerHTML = inner.join('');
      elTbody.appendChild(trd);
    }
  });
  document.getElementById('s_itens').textContent = calc.itens.length;
  document.getElementById('s_total').textContent = fmtBRL(calc.total);
  document.getElementById('s_gml').textContent = 'R$ ' + (calc.gml||0).toFixed(4).replace('.',',');
  document.getElementById('s_kgl').textContent = fmtBRL(calc.kgl);

  let unidadeVenda = 'un';
  if(TYPE(calc.unidade)==='mass') unidadeVenda = 'kg'; else if(TYPE(calc.unidade)==='vol') unidadeVenda = 'L';
  document.getElementById('kf_label').textContent = `Custo Final por ${unidadeVenda}`;
  document.getElementById('pv_hint').textContent  = `Base: ${calc.rendimento||0} ${(calc.unidade||'').toUpperCase()} por lote`;

  MARGEM = 0; document.getElementById('pv_input').value = '';

  document.getElementById('cardProd').style.display = 'block';
  document.getElementById('cardRec').style.display  = 'block';
  document.getElementById('cardCusto').style.display= 'block';
  document.getElementById('cardVenda').style.display= 'block';

  (async ()=>{
    const saved = await fetchPrecoSalvo(prodEnri);
    if(saved && typeof saved.margemPerc==='number'){
      MARGEM = saved.margemPerc;
      document.getElementById('pv_input').value = String(MARGEM).replace('.',',');
    }
    atualizarPreco();
  })();
}

function getRadio(name){ const x=[...document.querySelectorAll(`input[name="${name}"]`)].find(r=>r.checked); return x?x.value:'pct'; }
function lineValue(mode, rawVal, base){ const v = toNumberBR(rawVal); if(mode==='pct') return base * (v/100); return v; }

function atualizarCustos(){
  const base = BASE.total||0;
  ADD.imp.mode = getRadio('m_imp'); ADD.imp.val = document.getElementById('v_imp').value;
  ADD.fix.mode = getRadio('m_fix'); ADD.fix.val = document.getElementById('v_fix').value;
  ADD.op.mode  = getRadio('m_op');  ADD.op.val  = document.getElementById('v_op').value;

  const impV = lineValue(ADD.imp.mode, ADD.imp.val, base);
  const fixV = lineValue(ADD.fix.mode, ADD.fix.val, base);
  const opV  = lineValue(ADD.op.mode,  ADD.op.val,  base);
  const add  = impV + fixV + opV;
  const final= base + add;

  document.getElementById('r_imp').textContent = fmtBRL(impV);
  document.getElementById('r_fix').textContent = fmtBRL(fixV);
  document.getElementById('r_op').textContent  = fmtBRL(opV);
  document.getElementById('k_base').textContent = fmtBRL(base);
  document.getElementById('k_add').textContent  = fmtBRL(add);
  document.getElementById('k_final').textContent= fmtBRL(final);

  let perUnit = 0; const u = (BASE.unidade||'').toLowerCase(); const rend = Number(BASE.rendimento||0);
  if (rend > 0) { if (u === 'kg' || u === 'l') perUnit = final / rend; else if (u === 'g' || u === 'ml') perUnit = final / (rend / 1000); else perUnit = final / rend; }

  document.getElementById('k_final_unit').textContent = fmtBRL(perUnit);
  return { custoFinalLote: final, custoUnit: perUnit };
}

function atualizarPreco(){
  const { custoFinalLote, custoUnit } = atualizarCustos();

  // unitário -> lote
  let multLote = 1; const u = (BASE.unidade||'').toLowerCase(); const rend = Number(BASE.rendimento||0);
  if (u === 'kg' || u === 'l') multLote = rend; else if (u === 'g' || u === 'ml') multLote = rend / 1000; else multLote = rend || 1;

  let m = Number(MARGEM)||0; const warn = document.getElementById('pv_warn'); if(m < 0){ m = 0; warn.style.display='block'; } else { warn.style.display='none'; }

  // Preço = custoFinalLote * (1 + m/100)
  const fator = 1 + (m/100);
  const pvLote = custoFinalLote * fator;
  const pvPerUnit = pvLote / (multLote || 1);

  const markup = fator; // 1 + margem
  const lucro  = Math.max(0, pvLote - custoFinalLote);

  document.getElementById('pv_lote').textContent   = fmtBRL(pvLote||0);
  document.getElementById('pv_markup').textContent = markup ? (markup.toFixed(2)+'x') : '—';
  document.getElementById('pv_lucro').textContent  = fmtBRL(lucro||0);

  window.__PV_PER_UNIT = pvPerUnit; window.__PV_LOTE = pvLote; window.__PV_MARKUP = markup; window.__PV_LUCRO = lucro; window.__PV_MARGEM = m;
  preencherRelatorio();
}

/* ===== CSV ===== */
function exportCSV(){
  if(!BASE || !Array.isArray(BASE.itens)) return;
  const head = ['Item','Qtd','U.M.','Custo Unit. (R$)','Subtotal (R$)'];
  const rows = BASE.itens.map(r=>[
    `"${(r.item||'').replace(/\"/g,'"')}"`,
    String(r.qtd||0).replace('.',','),
    (r.um||'').toUpperCase(),
    (r.custoUnit||0).toFixed(4).replace('.',','),
    (r.subtotal||0).toFixed(2).replace('.',',')
  ]);
  rows.unshift(head);
  const csv = rows.map(r=>r.join(';')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `receita_${(PROD?.item||'produto').replace(/\s+/g,'_')}.csv`; a.click();
}

/* ===== RELATÓRIO ===== */
function preencherRelatorio(){
  // Logo só no relatório
  const logo = document.getElementById('repLogoImg'); if(LOGO_URL){ logo.src = LOGO_URL; logo.style.display='block'; } else { logo.removeAttribute('src'); logo.style.display='none'; }
  const meta = [];
  const emp = document.getElementById('empresa').value || (PROD?.empresa||''); if(emp) meta.push(emp);
  if(PROD){ meta.push((PROD.codigoSistema||'')||''); meta.push(PROD.numero?('Nº '+PROD.numero):''); }
  document.getElementById('repMeta').textContent = meta.filter(Boolean).join(' • ');
  document.getElementById('repProd').textContent = PROD ? (PROD.item||'(produto)') : '';

  // Corpo (itens + detalhes sempre expandidos no relatório)
  const repT = document.getElementById('repTbody'); repT.innerHTML = '';
  (BASE.itens||[]).forEach(r=>{
    const tr = document.createElement('tr'); tr.innerHTML = `<td>${r.item}</td><td class="right">${(r.qtd||0).toLocaleString('pt-BR')}</td><td>${(r.um||'')}</td><td class="right">${fmtBRL(r.custoUnit)}</td><td class="right">${fmtBRL(r.subtotal)}</td>`; repT.appendChild(tr);
    if(r.comp){
      const trd = document.createElement('tr'); trd.innerHTML = `<td colspan="5">
        <div style="padding:6px 6px 10px 6px">
          <div style="font-weight:700">Detalhe do composto — fator: ${(r.comp.conv||1).toLocaleString('pt-BR')} (preço por ${r.comp.umPreco})</div>
          <table style="width:100%"><thead><tr><th>Ingrediente</th><th class="right">Qtd</th><th>U.M.</th><th class="right">Custo Unit.</th><th class="right">Subtotal (linha)</th></tr></thead>
          <tbody>${r.comp.filhos.map(f=>`<tr><td>${f.nome}</td><td class="right">${(f.qtdComp||0).toLocaleString('pt-BR')}</td><td>${f.umComp}</td><td class="right">${fmtBRL(f.custoUnit)}</td><td class="right">${fmtBRL(f.valorLinha||0)}</td></tr>`).join('')}</tbody>
          <tfoot><tr><th colspan="4" class="right">Total componentes (linha)</th><th class="right">${fmtBRL(r.comp.totalLinha||0)}</th></tr></tfoot>
          </table>
        </div>
      </td>`; repT.appendChild(trd);
    }
  });

  // Resumos
  document.getElementById('repBase').textContent  = document.getElementById('k_base').textContent;
  document.getElementById('repAdd').textContent   = document.getElementById('k_add').textContent;
  document.getElementById('repFinal').textContent = document.getElementById('k_final').textContent;
  document.getElementById('repFinalUnit').textContent = document.getElementById('k_final_unit').textContent;
  const u = (BASE.unidade||'').toLowerCase(); let lbl='un'; if(u==='kg'||u==='g') lbl='kg'; else if(u==='l'||u==='ml') lbl='L';
  document.getElementById('repFinalUnitLbl').textContent = lbl;

  document.getElementById('repMargem').textContent = (Number(window.__PV_MARGEM||0)).toLocaleString('pt-BR') + ' %';
  document.getElementById('repMarkup').textContent = (Number(window.__PV_MARKUP||0)).toFixed(2) + 'x';
  document.getElementById('repLucro').textContent  = fmtBRL(Number(window.__PV_LUCRO||0));
  document.getElementById('repPV').textContent     = fmtBRL(Number(window.__PV_LOTE||0));
}

/* ===== UI eventos ===== */
function banner(msg, isErr=true){ const b=document.getElementById('netBanner'); b.textContent=msg||''; b.className=isErr?'err':''; b.style.display= msg? 'block':'none'; }

elEmpresa.addEventListener('change', async ()=>{ const emp = elEmpresa.value; if(!emp){ PRODUTOS=[]; renderSugestoes(); return; } await fetchProdutos(emp); });

document.getElementById('btnReload').addEventListener('click', async ()=>{ const emp = elEmpresa.value; if(emp) await fetchProdutos(emp); });

document.getElementById('btnPrint').addEventListener('click', ()=>{ preencherRelatorio(); window.print(); });

elBusca.addEventListener('input', renderSugestoes);
elBusca.addEventListener('focus', renderSugestoes);
elBusca.addEventListener('blur', ()=> setTimeout(()=> elTaList.style.display='none', 150));
elBusca.addEventListener('keydown', e=>{
  const items = [...elTaList.querySelectorAll('.ta-item')];
  if(e.key==='ArrowDown' && items.length){ e.preventDefault(); taActive=(taActive+1)%items.length; updateActive(); }
  else if(e.key==='ArrowUp' && items.length){ e.preventDefault(); taActive=(taActive-1+items.length)%items.length; updateActive(); }
  else if(e.key==='Enter'){
    if(items.length===1) selectByIndex(Number(items[0].dataset.idx));
    else if(taActive>=0) selectByIndex(Number(items[taActive].dataset.idx));
    else if(items.length>0) selectByIndex(Number(items[0].dataset.idx));
  }
});

['m_imp','m_fix','m_op'].forEach(name=>{
  document.querySelectorAll(`input[name="${name}"]`).forEach(r=>{
    r.addEventListener('change', ()=> atualizarPreco());
  });
});
document.getElementById('v_imp').addEventListener('input', ()=> atualizarPreco());
document.getElementById('v_fix').addEventListener('input', ()=> atualizarPreco());
document.getElementById('v_op').addEventListener('input',  ()=> atualizarPreco());

document.getElementById('pv_input').addEventListener('input', e=>{ MARGEM = toNumberBR(e.target.value); atualizarPreco(); });
document.getElementById('btnCSV').addEventListener('click', exportCSV);
document.getElementById('btnClear').addEventListener('click', ()=>{ ['v_imp','v_fix','v_op','pv_input'].forEach(id=>document.getElementById(id).value=''); MARGEM = 0; atualizarPreco(); });

document.getElementById('tbody').addEventListener('click', (e)=>{
  const b = e.target.closest('.det-toggle'); if(!b) return; const id = b.getAttribute('data-row'); const row = document.getElementById(id); if(!row) return; row.style.display = (row.style.display==='table-row')? 'none':'table-row';
});

document.getElementById('btnSalvarPainel').addEventListener('click', async ()=>{
  if(!PROD){ alert('Selecione um produto na busca.'); return; }
  const user = (document.getElementById('usuario').value || localStorage.getItem('AUTH_USER') || '').trim();

  atualizarPreco(); // garante cálculo atualizado
  const base = BASE.total||0;
  const impV = lineValue(document.querySelector('input[name="m_imp"]:checked').value, document.getElementById('v_imp').value, base);
  const fixV = lineValue(document.querySelector('input[name="m_fix"]:checked').value, document.getElementById('v_fix').value, base);
  const opV  = lineValue(document.querySelector('input[name="m_op"]:checked').value,  document.getElementById('v_op').value,  base);
  const addTot = impV+fixV+opV;
  const finalLote = base + addTot;

  let unidadeUnit = 'un'; const u = (BASE.unidade||'').toLowerCase(); const rend = Number(BASE.rendimento||0); let multLote = 1;
  if (u === 'kg' || u === 'l'){ multLote = rend; unidadeUnit = (u==='kg'?'kg':'L'); }
  else if (u === 'g' || u === 'ml'){ multLote = rend/1000; unidadeUnit = (u==='g'?'kg':'L'); }
  else { multLote = rend || 1; unidadeUnit='un'; }

  const pvUnit = Number(window.__PV_PER_UNIT||0);
  const pvLote = Number(window.__PV_LOTE||0);
  const markup = Number(window.__PV_MARKUP||0) || (pvUnit>0 ? (pvUnit / ((finalLote)/(multLote||1))) : 0);

  const payload = {
    empresa: PROD.empresa||elEmpresa.value||'',
    codigoSistema: PROD.codigoSistema||'',
    numero: PROD.numero||'',
    item: PROD.item||'',
    unidadeRend: BASE.unidade||'',
    rendimento: BASE.rendimento||0,
    custoReceitaLote: base,
    modoImpostos: document.querySelector('input[name="m_imp"]:checked').value,
    valorImpostos: toNumberBR(document.getElementById('v_imp')),
    modoDespFixa: document.querySelector('input[name="m_fix"]:checked').value,
    valorDespFixa: toNumberBR(document.getElementById('v_fix')),
    modoDespOper: document.querySelector('input[name="m_op"]:checked').value,
    valorDespOper: toNumberBR(document.getElementById('v_op')),
    custosAdicionaisLote: addTot,
    custoFinalLote: finalLote,
    custoFinalUnit: (finalLote/(multLote||1)),
    unidadeUnit,
    precoVendaUnit: pvUnit,
    precoVendaLote: pvLote,
    markup,
    margemPerc: Number(MARGEM||0),
    usuario: user
  };

  const res = await salvarPrecoPainel(payload);
  if(res.ok){ alert('Salvo no PainelPreco ✓'); }
  else { alert('Erro ao salvar: ' + (res.error||'desconhecido')); }
});

/* ===== BOOT ===== */
(async function boot(){
  if(LOGO_URL){ const im=document.getElementById('repLogoImg'); im.src = LOGO_URL; }
  await fetchEmpresas();
  try{ const savedUser = localStorage.getItem('AUTH_USER'); if(savedUser){ document.getElementById('usuario').value = savedUser; } }catch(_){}
  if(EMPRESAS.length){ elEmpresa.value = EMPRESAS[0]; await fetchProdutos(EMPRESAS[0]); }
})();
</script>
</body>
</html>
