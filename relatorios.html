<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>RelatÃ³rios e AnÃ¡lises</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{
    --bg:#0f0f10; --panel:#141414; --line:#2a2a2a; --text:#f0f0f0; --muted:#cfcfcf;
    --brand:#2563eb; --accent:#b75507; --ok:#16a34a; --warn:#f59e0b; --danger:#ef4444;
  }
  *{ box-sizing:border-box }
  body{
    font-family:'Inter',sans-serif;
    background:var(--bg); color:var(--text);
    margin:0; padding:24px;
  }
  header{
    display:flex;justify-content:space-between;align-items:center;
    gap:12px; margin-bottom:24px;
  }
  h1{margin:0;font-size:1.5rem;line-height:1.1}
  .btn{
    padding:10px 16px;border:none;border-radius:12px;cursor:pointer;font-weight:600;
    transition:transform .15s ease, opacity .15s ease;
  }
  .btn:active{ transform:scale(.98) }
  .btn.back{background:var(--accent);color:#fff}

  /* GRID */
  .grid{
    display:grid;
    grid-template-columns:repeat(12,1fr);
    gap:20px;
  }
  .span-6{ grid-column: span 6 }
  .span-4{ grid-column: span 4 }
  .span-8{ grid-column: span 8 }   /* âœ… faltava essa classe */
  .span-12{ grid-column: span 12 }

  .card{
    background:var(--panel);border:1px solid var(--line);
    border-radius:12px;padding:16px;box-shadow:0 4px 16px rgba(0,0,0,.3);
  }
  .card h2{font-size:1.1rem;margin:0 0 10px}
  .muted{ color:var(--muted) }
  .pill{ display:inline-block; padding:4px 8px; border-radius:999px; border:1px solid var(--line); background:#0d0d0e; font-size:.8rem }

  /* Chart wrapper garante altura responsiva */
  .chart-box{ position:relative; width:100%; height:220px }
  .chart-box.tall{ height:260px }

  /* tabelas */
  .table-wrap{ overflow:auto; border:1px solid var(--line); border-radius:10px }
  table{min-width:600px; width:100%; border-collapse:collapse}
  th,td{padding:8px 10px;border:1px solid var(--line);font-size:.92rem;text-align:left}
  th{background:#fff;color:#000;font-weight:600}
  tr.is-high td{ background: rgba(239,68,68,.12) }
  tr.is-mid td{ background: rgba(245,158,11,.12) }

  /* responsivo */
  @media (max-width: 1200px){
    .grid{ grid-template-columns:repeat(8,1fr) }
    .span-6{ grid-column: span 8 }
    .span-4{ grid-column: span 4 }
    .span-8{ grid-column: span 8 }
  }
  @media (max-width: 1024px){
    body{ padding:18px }
    .grid{ grid-template-columns:repeat(6,1fr) }
    .span-6{ grid-column: span 6 }
    .span-4{ grid-column: span 6 }
    .span-8{ grid-column: span 6 }
    .btn{ min-height:44px }
  }
  @media (max-width: 768px){
    body{ padding:12px }
    header{ flex-direction:column; align-items:flex-start }
    h1{ font-size:1.25rem }
    .grid{ grid-template-columns:1fr; gap:14px }
    .span-6, .span-4, .span-8, .span-12{ grid-column: span 1 }
    .card{ padding:14px }
    th,td{ white-space:nowrap }
    .btn{ width:100% }
    .chart-box{ height:200px }
  }
  @media (hover: none){
    .btn{ min-height:44px }
  }
</style>
</head>
<body>

<header>
  <h1>RelatÃ³rios e AnÃ¡lises</h1>
  <button class="btn back" onclick="window.location.href='index.analise.html'">â¬… Voltar</button>
</header>

<div class="grid">

  <!-- 1. Quantidade / Custos das Receitas -->
  <div class="card span-6">
    <h2>ðŸ“Œ Custo das Receitas</h2>
    <div class="chart-box">
      <canvas id="chartReceitas"></canvas>
    </div>
    <div id="resumoReceitas" style="margin-top:10px;font-size:.9rem">
      <span class="pill">Total de receitas: <b id="totalReceitas">0</b></span>
    </div>
  </div>

  <!-- 2. Produtos com custos diferentes -->
  <div class="card span-6">
    <h2>ðŸ’° Produtos com Custos Muito Diferentes</h2>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Produto</th>
            <th>Custo MÃ­n.</th>
            <th>Custo MÃ¡x.</th>
            <th>VariaÃ§Ã£o</th>
          </tr>
        </thead>
        <tbody id="tblProdutos"></tbody>
      </table>
    </div>
    <div class="muted" style="margin-top:8px;font-size:.9rem">
      Itens destacados tÃªm variaÃ§Ã£o acima do limite configurado.
    </div>
  </div>

  <!-- 3. Ingredientes com variaÃ§Ã£o alta -->
  <div class="card span-4">
    <h2>ðŸ¥— DiferenÃ§a de Custo por Ingrediente</h2>
    <div class="chart-box tall">
      <canvas id="chartIngredientes"></canvas>
    </div>
  </div>

  <!-- 4. AnÃ¡lise Detalhada -->
  <div class="card span-8">
    <h2>ðŸ”Ž AnÃ¡lise Detalhada</h2>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Receita</th>
            <th>Qtd. Ingredientes</th>
            <th>Custo Total</th>
            <th>Custo MÃ©dio</th>
          </tr>
        </thead>
        <tbody id="tblDetalhada"></tbody>
      </table>
    </div>
  </div>

</div>

<script>
/* ========= Helpers ========= */
const fmtBRL = n => (Number(n)||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});

/* ========= Dados mockados (substituir por Apps Script depois) ========= */
const receitas = [
  {nome:"Bolo Chocolate", qtdIng:5, custo:45},
  {nome:"PÃ£o FrancÃªs",    qtdIng:3, custo:25},
  {nome:"Pizza Mussarela",qtdIng:6, custo:60},
  {nome:"Torta Frango",   qtdIng:7, custo:55},
];

const produtos = [
  {nome:"Farinha", min:4.5, max:7.0},
  {nome:"Leite",   min:3.2, max:5.5},
  {nome:"Ovo",     min:0.4, max:0.9},
];

/* ========= 1. Custo das Receitas (bar) ========= */
document.getElementById("totalReceitas").innerText = receitas.length;

const ctx1 = document.getElementById("chartReceitas");
new Chart(ctx1, {
  type:"bar",
  data:{
    labels:receitas.map(r=>r.nome),
    datasets:[
      {
        label:"Custo (R$)",
        data:receitas.map(r=>r.custo),
        backgroundColor:"#2563eb"
      },
      {
        label:"Qtd. ingredientes",
        data:receitas.map(r=>r.qtdIng),
        type:"line",
        borderColor:"#f59e0b",
        borderWidth:2,
        pointRadius:3,
        fill:false,
        yAxisID:'y2'
      }
    ]
  },
  options:{
    responsive:true,
    maintainAspectRatio:false,
    plugins:{
      legend:{ labels:{ color:"#e5e7eb" } },
      tooltip:{
        callbacks:{
          label:(c)=>{
            if(c.datasetIndex===0) return `${c.label}: ${fmtBRL(c.parsed.y)}`;
            return `${c.label}: ${c.parsed.y}`;
          }
        }
      }
    },
    scales:{
      x:{ ticks:{ color:"#cbd5e1" }, grid:{ color:"rgba(255,255,255,.06)" } },
      y:{
        ticks:{ color:"#cbd5e1" },
        grid:{ color:"rgba(255,255,255,.06)" },
        title:{ display:true, text:"Custo (R$)", color:"#cbd5e1" }
      },
      y2:{
        position:'right',
        grid:{ display:false },
        ticks:{ color:"#fbbf24" },
        title:{ display:true, text:"Qtd. ingredientes", color:"#fbbf24" }
      }
    }
  }
});

/* ========= 2. Produtos com custos diferentes (tabela com destaque) ========= */
const tbodyP = document.getElementById("tblProdutos");
const limiteAbs = 2.0;   // R$
const limitePerc = 0.35; // 35%

const produtosOrdenados = [...produtos].sort((a,b)=>(b.max-b.min)-(a.max-a.min));
produtosOrdenados.forEach(p=>{
  const variacaoAbs  = (p.max - p.min);
  const variacaoPerc = p.min>0 ? (variacaoAbs / p.min) : 0;
  const cls = variacaoPerc >= 0.6 || variacaoAbs >= 5 ? 'is-high'
            : (variacaoPerc >= limitePerc || variacaoAbs >= limiteAbs) ? 'is-mid' : '';

  const tr = document.createElement('tr');
  if(cls) tr.classList.add(cls);
  tr.innerHTML = `
    <td>${p.nome}</td>
    <td>${fmtBRL(p.min)}</td>
    <td>${fmtBRL(p.max)}</td>
    <td>${fmtBRL(variacaoAbs)} (${(variacaoPerc*100).toFixed(0)}%)</td>
  `;
  tbodyP.appendChild(tr);
});

/* ========= 3. DiferenÃ§a por Ingrediente (pie) ========= */
const diffs = produtos.map(p=>Math.max(0,(p.max-p.min)));
const labelsIng = produtos.map(p=>p.nome);

// gera paleta segura (repete se precisar)
const palette = ["#2563eb","#f59e0b","#ef4444","#10b981","#a78bfa","#f97316","#22c55e","#eab308","#3b82f6","#f43f5e"];
const colors = labelsIng.map((_,i)=>palette[i % palette.length]);

const ctx2 = document.getElementById("chartIngredientes");
new Chart(ctx2, {
  type:"pie",
  data:{
    labels: labelsIng,
    datasets:[{
      data: diffs,
      backgroundColor: colors,
      borderColor: "rgba(0,0,0,.25)",
      borderWidth: 1
    }]
  },
  options:{
    responsive:true,
    maintainAspectRatio:false,
    plugins:{
      legend:{ position:'bottom', labels:{ color:"#e5e7eb" } },
      tooltip:{ callbacks:{ label:(c)=>`${c.label}: ${fmtBRL(c.parsed)}` } }
    }
  }
});

/* ========= 4. AnÃ¡lise detalhada (tabela) ========= */
const tbodyD = document.getElementById("tblDetalhada");
receitas.forEach(r=>{
  const custoMedio = r.qtdIng>0 ? (r.custo/r.qtdIng) : 0;
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td>${r.nome}</td>
    <td>${r.qtdIng}</td>
    <td>${fmtBRL(r.custo)}</td>
    <td>${fmtBRL(custoMedio)}</td>
  `;
  tbodyD.appendChild(tr);
});

/* ========= (Hook futuro) carregar via Apps Script =========
fetch(WEBAPP_URL+'?action=relatorios')
  .then(r=>r.json())
  .then(j=>{ ...atualizar charts e tabelas... });
*/
</script>

</body>
</html>
